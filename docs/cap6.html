<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>4&nbsp; Capítulo 6 – Series de Tiempo</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./cap5.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./cap6.html"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Capítulo 6</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Series de Tiempo</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Prefacio</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./box_jenk.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Enfoque de Box-Jenkins</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cap4.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Capítulo 4</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cap5.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Capítulo 5</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cap6.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Capítulo 6</span></span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#a-biomedical-example" id="toc-a-biomedical-example" class="nav-link active" data-scroll-target="#a-biomedical-example"><span class="header-section-number">5</span> A Biomedical Example</a>
  <ul class="collapse">
  <li><a href="#introduction" id="toc-introduction" class="nav-link" data-scroll-target="#introduction"><span class="header-section-number">5.1</span> Introduction</a></li>
  <li><a href="#objective" id="toc-objective" class="nav-link" data-scroll-target="#objective"><span class="header-section-number">5.2</span> Objective</a></li>
  <li><a href="#methodology" id="toc-methodology" class="nav-link" data-scroll-target="#methodology"><span class="header-section-number">5.3</span> Methodology</a></li>
  <li><a href="#visualization" id="toc-visualization" class="nav-link" data-scroll-target="#visualization"><span class="header-section-number">5.4</span> Visualization</a></li>
  </ul></li>
  <li><a href="#global-warming" id="toc-global-warming" class="nav-link" data-scroll-target="#global-warming"><span class="header-section-number">6</span> Global Warming</a>
  <ul class="collapse">
  <li><a href="#introduction-1" id="toc-introduction-1" class="nav-link" data-scroll-target="#introduction-1"><span class="header-section-number">6.1</span> Introduction</a></li>
  <li><a href="#objective-1" id="toc-objective-1" class="nav-link" data-scroll-target="#objective-1"><span class="header-section-number">6.2</span> Objective</a></li>
  <li><a href="#data-visualization" id="toc-data-visualization" class="nav-link" data-scroll-target="#data-visualization"><span class="header-section-number">6.3</span> Data Visualization</a></li>
  </ul></li>
  <li><a href="#prediction-filtering-and-smoothing-for-the-local-level-model" id="toc-prediction-filtering-and-smoothing-for-the-local-level-model" class="nav-link" data-scroll-target="#prediction-filtering-and-smoothing-for-the-local-level-model"><span class="header-section-number">7</span> Prediction, Filtering, and Smoothing for the Local Level Model</a>
  <ul class="collapse">
  <li><a href="#introduction-2" id="toc-introduction-2" class="nav-link" data-scroll-target="#introduction-2"><span class="header-section-number">7.1</span> Introduction</a></li>
  <li><a href="#model-description" id="toc-model-description" class="nav-link" data-scroll-target="#model-description"><span class="header-section-number">7.2</span> Model Description</a></li>
  <li><a href="#data-generation" id="toc-data-generation" class="nav-link" data-scroll-target="#data-generation"><span class="header-section-number">7.3</span> Data Generation</a></li>
  <li><a href="#kalman-filter-and-smoothing" id="toc-kalman-filter-and-smoothing" class="nav-link" data-scroll-target="#kalman-filter-and-smoothing"><span class="header-section-number">7.4</span> Kalman Filter and Smoothing</a></li>
  <li><a href="#visualization-of-results" id="toc-visualization-of-results" class="nav-link" data-scroll-target="#visualization-of-results"><span class="header-section-number">7.5</span> Visualization of Results</a></li>
  <li><a href="#initial-state-information" id="toc-initial-state-information" class="nav-link" data-scroll-target="#initial-state-information"><span class="header-section-number">7.6</span> Initial State Information</a></li>
  </ul></li>
  <li><a href="#newton-raphson-for-ar1" id="toc-newton-raphson-for-ar1" class="nav-link" data-scroll-target="#newton-raphson-for-ar1"><span class="header-section-number">8</span> Newton-Raphson for AR(1)</a>
  <ul class="collapse">
  <li><a href="#data-generation-1" id="toc-data-generation-1" class="nav-link" data-scroll-target="#data-generation-1"><span class="header-section-number">8.1</span> Data Generation</a></li>
  <li><a href="#initial-parameter-estimates" id="toc-initial-parameter-estimates" class="nav-link" data-scroll-target="#initial-parameter-estimates"><span class="header-section-number">8.2</span> Initial Parameter Estimates</a></li>
  <li><a href="#likelihood-evaluation-function" id="toc-likelihood-evaluation-function" class="nav-link" data-scroll-target="#likelihood-evaluation-function"><span class="header-section-number">8.3</span> Likelihood Evaluation Function</a></li>
  <li><a href="#parameter-estimation" id="toc-parameter-estimation" class="nav-link" data-scroll-target="#parameter-estimation"><span class="header-section-number">8.4</span> Parameter Estimation</a></li>
  </ul></li>
  <li><a href="#kalman-filtering-and-smoothing-for-global-temperature-series" id="toc-kalman-filtering-and-smoothing-for-global-temperature-series" class="nav-link" data-scroll-target="#kalman-filtering-and-smoothing-for-global-temperature-series"><span class="header-section-number">9</span> Kalman Filtering and Smoothing for Global Temperature Series</a>
  <ul class="collapse">
  <li><a href="#setup" id="toc-setup" class="nav-link" data-scroll-target="#setup"><span class="header-section-number">9.1</span> Setup</a></li>
  <li><a href="#function-to-calculate-likelihood" id="toc-function-to-calculate-likelihood" class="nav-link" data-scroll-target="#function-to-calculate-likelihood"><span class="header-section-number">9.2</span> Function to Calculate Likelihood</a></li>
  <li><a href="#parameter-estimation-1" id="toc-parameter-estimation-1" class="nav-link" data-scroll-target="#parameter-estimation-1"><span class="header-section-number">9.3</span> Parameter Estimation</a></li>
  <li><a href="#smoothing" id="toc-smoothing" class="nav-link" data-scroll-target="#smoothing"><span class="header-section-number">9.4</span> Smoothing</a></li>
  <li><a href="#plotting-results" id="toc-plotting-results" class="nav-link" data-scroll-target="#plotting-results"><span class="header-section-number">9.5</span> Plotting Results</a></li>
  </ul></li>
  <li><a href="#em-algorithm-estimation-for-ar1-model-parameters" id="toc-em-algorithm-estimation-for-ar1-model-parameters" class="nav-link" data-scroll-target="#em-algorithm-estimation-for-ar1-model-parameters"><span class="header-section-number">10</span> EM Algorithm Estimation for AR(1) Model Parameters</a>
  <ul class="collapse">
  <li><a href="#introduction-3" id="toc-introduction-3" class="nav-link" data-scroll-target="#introduction-3"><span class="header-section-number">10.1</span> Introduction</a></li>
  <li><a href="#load-required-package" id="toc-load-required-package" class="nav-link" data-scroll-target="#load-required-package"><span class="header-section-number">10.2</span> Load Required Package</a></li>
  <li><a href="#data-generation-2" id="toc-data-generation-2" class="nav-link" data-scroll-target="#data-generation-2"><span class="header-section-number">10.3</span> Data Generation</a></li>
  <li><a href="#initial-parameter-estimates-1" id="toc-initial-parameter-estimates-1" class="nav-link" data-scroll-target="#initial-parameter-estimates-1"><span class="header-section-number">10.4</span> Initial Parameter Estimates</a></li>
  <li><a href="#em-algorithm-procedure" id="toc-em-algorithm-procedure" class="nav-link" data-scroll-target="#em-algorithm-procedure"><span class="header-section-number">10.5</span> EM Algorithm Procedure</a></li>
  <li><a href="#calculation-of-standard-errors" id="toc-calculation-of-standard-errors" class="nav-link" data-scroll-target="#calculation-of-standard-errors"><span class="header-section-number">10.6</span> Calculation of Standard Errors</a></li>
  <li><a href="#summary-of-final-estimates" id="toc-summary-of-final-estimates" class="nav-link" data-scroll-target="#summary-of-final-estimates"><span class="header-section-number">10.7</span> Summary of Final Estimates</a></li>
  </ul></li>
  <li><a href="#em-algorithm-for-multivariate-biomedical-data-missing-data" id="toc-em-algorithm-for-multivariate-biomedical-data-missing-data" class="nav-link" data-scroll-target="#em-algorithm-for-multivariate-biomedical-data-missing-data"><span class="header-section-number">11</span> EM Algorithm for Multivariate Biomedical Data (missing data)</a>
  <ul class="collapse">
  <li><a href="#introduction-4" id="toc-introduction-4" class="nav-link" data-scroll-target="#introduction-4"><span class="header-section-number">11.1</span> Introduction</a></li>
  <li><a href="#data-setup" id="toc-data-setup" class="nav-link" data-scroll-target="#data-setup"><span class="header-section-number">11.2</span> Data Setup</a></li>
  <li><a href="#initial-parameter-values" id="toc-initial-parameter-values" class="nav-link" data-scroll-target="#initial-parameter-values"><span class="header-section-number">11.3</span> Initial Parameter Values</a></li>
  <li><a href="#em-algorithm-procedure-1" id="toc-em-algorithm-procedure-1" class="nav-link" data-scroll-target="#em-algorithm-procedure-1"><span class="header-section-number">11.4</span> EM Algorithm Procedure</a></li>
  <li><a href="#smoothing-with-kalman-smoother" id="toc-smoothing-with-kalman-smoother" class="nav-link" data-scroll-target="#smoothing-with-kalman-smoother"><span class="header-section-number">11.5</span> Smoothing with Kalman Smoother</a></li>
  <li><a href="#plotting-results-1" id="toc-plotting-results-1" class="nav-link" data-scroll-target="#plotting-results-1"><span class="header-section-number">11.6</span> Plotting Results</a></li>
  </ul></li>
  <li><a href="#structural-models-parameter-estimation-and-smoothing-for-jj-time-series" id="toc-structural-models-parameter-estimation-and-smoothing-for-jj-time-series" class="nav-link" data-scroll-target="#structural-models-parameter-estimation-and-smoothing-for-jj-time-series"><span class="header-section-number">12</span> Structural Models: Parameter Estimation and Smoothing for J&amp;J Time Series</a>
  <ul class="collapse">
  <li><a href="#introduction-5" id="toc-introduction-5" class="nav-link" data-scroll-target="#introduction-5"><span class="header-section-number">12.1</span> Introduction</a></li>
  <li><a href="#setup-1" id="toc-setup-1" class="nav-link" data-scroll-target="#setup-1"><span class="header-section-number">12.2</span> Setup</a></li>
  <li><a href="#likelihood-function" id="toc-likelihood-function" class="nav-link" data-scroll-target="#likelihood-function"><span class="header-section-number">12.3</span> Likelihood Function</a></li>
  <li><a href="#parameter-estimation-2" id="toc-parameter-estimation-2" class="nav-link" data-scroll-target="#parameter-estimation-2"><span class="header-section-number">12.4</span> Parameter Estimation</a></li>
  <li><a href="#smoothing-with-kalman-smoother-1" id="toc-smoothing-with-kalman-smoother-1" class="nav-link" data-scroll-target="#smoothing-with-kalman-smoother-1"><span class="header-section-number">12.5</span> Smoothing with Kalman Smoother</a></li>
  <li><a href="#plotting-results-2" id="toc-plotting-results-2" class="nav-link" data-scroll-target="#plotting-results-2"><span class="header-section-number">12.6</span> Plotting Results</a></li>
  <li><a href="#forecasting" id="toc-forecasting" class="nav-link" data-scroll-target="#forecasting"><span class="header-section-number">12.7</span> Forecasting</a></li>
  </ul></li>
  <li><a href="#stochastic-regression" id="toc-stochastic-regression" class="nav-link" data-scroll-target="#stochastic-regression"><span class="header-section-number">13</span> Stochastic Regression</a>
  <ul class="collapse">
  <li><a href="#introduction-6" id="toc-introduction-6" class="nav-link" data-scroll-target="#introduction-6"><span class="header-section-number">13.1</span> Introduction</a></li>
  <li><a href="#setup-2" id="toc-setup-2" class="nav-link" data-scroll-target="#setup-2"><span class="header-section-number">13.2</span> Setup</a></li>
  <li><a href="#likelihood-function-1" id="toc-likelihood-function-1" class="nav-link" data-scroll-target="#likelihood-function-1"><span class="header-section-number">13.3</span> Likelihood Function</a></li>
  <li><a href="#parameter-estimation-3" id="toc-parameter-estimation-3" class="nav-link" data-scroll-target="#parameter-estimation-3"><span class="header-section-number">13.4</span> Parameter Estimation</a></li>
  <li><a href="#bootstrap-procedure" id="toc-bootstrap-procedure" class="nav-link" data-scroll-target="#bootstrap-procedure"><span class="header-section-number">13.5</span> Bootstrap Procedure</a></li>
  <li><a href="#standard-error-calculation-from-bootstrap" id="toc-standard-error-calculation-from-bootstrap" class="nav-link" data-scroll-target="#standard-error-calculation-from-bootstrap"><span class="header-section-number">13.6</span> Standard Error Calculation from Bootstrap</a></li>
  <li><a href="#scatter-plot-of-bootstrap-estimates" id="toc-scatter-plot-of-bootstrap-estimates" class="nav-link" data-scroll-target="#scatter-plot-of-bootstrap-estimates"><span class="header-section-number">13.7</span> Scatter Plot of Bootstrap Estimates</a></li>
  </ul></li>
  <li><a href="#hidden-markov-model-for-earthquake-counts-using-depmixs4" id="toc-hidden-markov-model-for-earthquake-counts-using-depmixs4" class="nav-link" data-scroll-target="#hidden-markov-model-for-earthquake-counts-using-depmixs4"><span class="header-section-number">14</span> Hidden Markov Model for Earthquake Counts Using depmixS4</a>
  <ul class="collapse">
  <li><a href="#introduction-7" id="toc-introduction-7" class="nav-link" data-scroll-target="#introduction-7"><span class="header-section-number">14.1</span> Introduction</a></li>
  <li><a href="#model-setup-and-estimation" id="toc-model-setup-and-estimation" class="nav-link" data-scroll-target="#model-setup-and-estimation"><span class="header-section-number">14.2</span> Model Setup and Estimation</a></li>
  <li><a href="#visualization-1" id="toc-visualization-1" class="nav-link" data-scroll-target="#visualization-1"><span class="header-section-number">14.3</span> Visualization</a></li>
  <li><a href="#bootstrap-procedure-1" id="toc-bootstrap-procedure-1" class="nav-link" data-scroll-target="#bootstrap-procedure-1"><span class="header-section-number">14.4</span> Bootstrap Procedure</a></li>
  <li><a href="#bootstrapped-standard-errors" id="toc-bootstrapped-standard-errors" class="nav-link" data-scroll-target="#bootstrapped-standard-errors"><span class="header-section-number">14.5</span> Bootstrapped Standard Errors</a></li>
  </ul></li>
  <li><a href="#hidden-markov-model-for-sp500-weekly-returns." id="toc-hidden-markov-model-for-sp500-weekly-returns." class="nav-link" data-scroll-target="#hidden-markov-model-for-sp500-weekly-returns."><span class="header-section-number">15</span> Hidden Markov Model for S&amp;P500 Weekly Returns.</a>
  <ul class="collapse">
  <li><a href="#introduction-8" id="toc-introduction-8" class="nav-link" data-scroll-target="#introduction-8"><span class="header-section-number">15.1</span> Introduction</a></li>
  <li><a href="#model-setup-and-estimation-1" id="toc-model-setup-and-estimation-1" class="nav-link" data-scroll-target="#model-setup-and-estimation-1"><span class="header-section-number">15.2</span> Model Setup and Estimation</a></li>
  <li><a href="#parameter-estimates" id="toc-parameter-estimates" class="nav-link" data-scroll-target="#parameter-estimates"><span class="header-section-number">15.3</span> Parameter Estimates</a></li>
  <li><a href="#visualization-2" id="toc-visualization-2" class="nav-link" data-scroll-target="#visualization-2"><span class="header-section-number">15.4</span> Visualization</a></li>
  <li><a href="#bootstrap-procedure-2" id="toc-bootstrap-procedure-2" class="nav-link" data-scroll-target="#bootstrap-procedure-2"><span class="header-section-number">15.5</span> Bootstrap Procedure</a></li>
  <li><a href="#bootstrap-standard-errors" id="toc-bootstrap-standard-errors" class="nav-link" data-scroll-target="#bootstrap-standard-errors"><span class="header-section-number">15.6</span> Bootstrap Standard Errors</a></li>
  </ul></li>
  <li><a href="#influenza-regime-switching-model" id="toc-influenza-regime-switching-model" class="nav-link" data-scroll-target="#influenza-regime-switching-model"><span class="header-section-number">16</span> Influenza Regime-Switching Model</a>
  <ul class="collapse">
  <li><a href="#introduction-9" id="toc-introduction-9" class="nav-link" data-scroll-target="#introduction-9"><span class="header-section-number">16.1</span> Introduction</a></li>
  <li><a href="#data-setup-and-initialization" id="toc-data-setup-and-initialization" class="nav-link" data-scroll-target="#data-setup-and-initialization"><span class="header-section-number">16.2</span> Data Setup and Initialization</a></li>
  <li><a href="#likelihood-function-2" id="toc-likelihood-function-2" class="nav-link" data-scroll-target="#likelihood-function-2"><span class="header-section-number">16.3</span> Likelihood Function</a></li>
  <li><a href="#parameter-estimation-4" id="toc-parameter-estimation-4" class="nav-link" data-scroll-target="#parameter-estimation-4"><span class="header-section-number">16.4</span> Parameter Estimation</a></li>
  <li><a href="#visualization-3" id="toc-visualization-3" class="nav-link" data-scroll-target="#visualization-3"><span class="header-section-number">16.5</span> Visualization</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Capítulo 6</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="a-biomedical-example" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> A Biomedical Example</h1>
<section id="introduction" class="level2" data-number="5.1">
<h2 data-number="5.1" class="anchored" data-anchor-id="introduction"><span class="header-section-number">5.1</span> Introduction</h2>
<p>This example examines the monitoring of biomedical markers in a cancer patient following a bone marrow transplant. Measurements are recorded daily for 91 days on three variables: - log(white blood cell count) [WBC] - log(platelet count) [PLT] - hematocrit [HCT]</p>
<p>These markers are represented as a vector ( y_t = (y_{t1}, y_{t2}, y_{t3})’ ). Approximately 40% of the data is missing, mainly from day 35 onwards.</p>
</section>
<section id="objective" class="level2" data-number="5.2">
<h2 data-number="5.2" class="anchored" data-anchor-id="objective"><span class="header-section-number">5.2</span> Objective</h2>
<p>The primary goals are to: 1. Model the dynamics of the three variables using a state-space approach. 2. Estimate missing values.</p>
<p>Platelet count around 100 days post-transplant is identified as a significant predictor of long-term survival, emphasizing its importance in the analysis.</p>
</section>
<section id="methodology" class="level2" data-number="5.3">
<h2 data-number="5.3" class="anchored" data-anchor-id="methodology"><span class="header-section-number">5.3</span> Methodology</h2>
<p>The state-space model is employed for this analysis. We define the state vector ( x_t ) and the state equation as follows:</p>
<p><span class="math display">\[
\begin{pmatrix}
x_{t2} \\
x_{t1}
\end{pmatrix}
=
\begin{pmatrix}
\phi_{21} &amp; \phi_{11} &amp; \phi_{12} \\
\phi_{32} &amp; \phi_{22} &amp; \phi_{13} \\
\phi_{33} &amp; \phi_{23} &amp; \phi_{31}
\end{pmatrix}
\begin{pmatrix}
x_{t-1,2} \\
x_{t-1,1}
\end{pmatrix} +
\begin{pmatrix}
w_{t2} \\
w_{t1}
\end{pmatrix}
\]</span></p>
<p>The observation equation for each day depends on whether a blood sample was taken, represented by an observation matrix ( A_t ), which is either the identity matrix or zero. The covariance matrices ( R ) and ( Q ) are each ( 3 ) matrices.</p>
</section>
<section id="visualization" class="level2" data-number="5.4">
<h2 data-number="5.4" class="anchored" data-anchor-id="visualization"><span class="header-section-number">5.4</span> Visualization</h2>
<p>To visualize the data (similar to Figure 6.2), we can use the following R code:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(astsa)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(blood, <span class="at">type=</span><span class="st">'o'</span>, <span class="at">pch=</span><span class="dv">19</span>, <span class="at">xlab=</span><span class="st">'day'</span>, <span class="at">main=</span><span class="st">'Biomedical Markers Over 91 Days'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="cap6_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="global-warming" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> Global Warming</h1>
<section id="introduction-1" class="level2" data-number="6.1">
<h2 data-number="6.1" class="anchored" data-anchor-id="introduction-1"><span class="header-section-number">6.1</span> Introduction</h2>
<p>This example explores historical temperature records from 1880 to 2015, focusing on two temperature series: 1. <strong>globtemp</strong>: the global mean land-ocean temperature index. 2. <strong>globtempl</strong>: the surface air temperature index based on meteorological station data only.</p>
<p>Both series aim to represent global temperature trends and, ideally, reflect the same underlying climate signal.</p>
</section>
<section id="objective-1" class="level2" data-number="6.2">
<h2 data-number="6.2" class="anchored" data-anchor-id="objective-1"><span class="header-section-number">6.2</span> Objective</h2>
<p>The main objective is to extract a consistent, underlying signal of climate change from these two temperature estimators, which are expected to converge on a similar long-term trend in global temperature deviations.</p>
</section>
<section id="data-visualization" class="level2" data-number="6.3">
<h2 data-number="6.3" class="anchored" data-anchor-id="data-visualization"><span class="header-section-number">6.3</span> Data Visualization</h2>
<p>A plot comparing the two series provides a visual representation of their alignment and divergence over time. The R code below generates this comparison, with globtemp in one color and globtempl in another:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot of Global Temperature Series Over Time</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ts.plot</span>(gtemp_both, gtemp_land, <span class="at">col=</span><span class="fu">c</span>(<span class="dv">6</span>,<span class="dv">4</span>), <span class="at">ylab=</span><span class="st">'Temperature Deviations'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="cap6_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="prediction-filtering-and-smoothing-for-the-local-level-model" class="level1" data-number="7">
<h1 data-number="7"><span class="header-section-number">7</span> Prediction, Filtering, and Smoothing for the Local Level Model</h1>
<section id="introduction-2" class="level2" data-number="7.1">
<h2 data-number="7.1" class="anchored" data-anchor-id="introduction-2"><span class="header-section-number">7.1</span> Introduction</h2>
<p>This example demonstrates the application of prediction, filtering, and smoothing to a simulated univariate time series based on the local level model. The series was generated with 50 observations, where we modeled the trend using a random walk and added observational noise.</p>
</section>
<section id="model-description" class="level2" data-number="7.2">
<h2 data-number="7.2" class="anchored" data-anchor-id="model-description"><span class="header-section-number">7.2</span> Model Description</h2>
<p>The local level model consists of: 1. <strong>Trend Component</strong>: <span class="math display">\[
   \mu_t = \mu_{t-1} + w_t
   \]</span> where $ w_t &nbsp;N(0, 1) $ and $ _0 N(0, 1) $.</p>
<ol start="2" type="1">
<li><strong>Observation Equation</strong>: <span class="math display">\[
y_t = \mu_t + v_t
\]</span> where $ v_t &nbsp;N(0, 1) $.</li>
</ol>
<p>In this setup, $ {w_t} $, $ {v_t} $, and $ _0 $ are generated independently.</p>
</section>
<section id="data-generation" class="level2" data-number="7.3">
<h2 data-number="7.3" class="anchored" data-anchor-id="data-generation"><span class="header-section-number">7.3</span> Data Generation</h2>
<p>The following code generates data for a local level model with 50 observations. We initialize a random walk for the state ( ) and add observational noise to produce the observed series ( y ).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate data</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>num <span class="ot">&lt;-</span> <span class="dv">50</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>w <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(num <span class="sc">+</span> <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>)  <span class="co"># process noise</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>v <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(num, <span class="dv">0</span>, <span class="dv">1</span>)      <span class="co"># observation noise</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>mu <span class="ot">&lt;-</span> <span class="fu">cumsum</span>(w)             <span class="co"># state: mu[0], mu[1], ..., mu[50]</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> mu[<span class="sc">-</span><span class="dv">1</span>] <span class="sc">+</span> v             <span class="co"># observations: y[1], ..., y[50]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="kalman-filter-and-smoothing" class="level2" data-number="7.4">
<h2 data-number="7.4" class="anchored" data-anchor-id="kalman-filter-and-smoothing"><span class="header-section-number">7.4</span> Kalman Filter and Smoothing</h2>
<p>We use the <code>Ksmooth</code> function to apply both filtering and smoothing on the observations.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply Kalman filter and smoother</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>ks <span class="ot">&lt;-</span> <span class="fu">Ksmooth</span>(y, <span class="at">A =</span> <span class="dv">1</span>, <span class="at">mu0 =</span> <span class="dv">0</span>, <span class="at">Sigma0 =</span> <span class="dv">1</span>, <span class="at">Phi =</span> <span class="dv">1</span>, <span class="at">sQ =</span> <span class="dv">1</span>, <span class="at">sR =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="visualization-of-results" class="level2" data-number="7.5">
<h2 data-number="7.5" class="anchored" data-anchor-id="visualization-of-results"><span class="header-section-number">7.5</span> Visualization of Results</h2>
<p>The following plots display the results of prediction, filtering, and smoothing. Each plot includes the estimated trend line, with shaded confidence intervals representing the uncertainty bounds.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot setup</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">1</span>))</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>Time <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span>num</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Prediction Plot</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(Time, mu[<span class="sc">-</span><span class="dv">1</span>], <span class="at">main =</span> <span class="st">'Predict'</span>, <span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">5</span>, <span class="dv">10</span>), <span class="at">xlab =</span> <span class="st">'Time'</span>, <span class="at">ylab =</span> <span class="st">'State'</span>)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(ks<span class="sc">$</span>Xp, <span class="at">col =</span> <span class="st">'blue'</span>)  <span class="co"># Prediction</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(ks<span class="sc">$</span>Xp <span class="sc">+</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fu">sqrt</span>(ks<span class="sc">$</span>Pp), <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">col =</span> <span class="dv">4</span>)  <span class="co"># Upper confidence interval</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(ks<span class="sc">$</span>Xp <span class="sc">-</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fu">sqrt</span>(ks<span class="sc">$</span>Pp), <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">col =</span> <span class="dv">4</span>)  <span class="co"># Lower confidence interval</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Filtering Plot</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(Time, mu[<span class="sc">-</span><span class="dv">1</span>], <span class="at">main =</span> <span class="st">'Filter'</span>, <span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">5</span>, <span class="dv">10</span>), <span class="at">xlab =</span> <span class="st">'Time'</span>, <span class="at">ylab =</span> <span class="st">'State'</span>)</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(ks<span class="sc">$</span>Xf, <span class="at">col =</span> <span class="st">'blue'</span>)  <span class="co"># Filtered estimate</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(ks<span class="sc">$</span>Xf <span class="sc">+</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fu">sqrt</span>(ks<span class="sc">$</span>Pf), <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">col =</span> <span class="dv">4</span>)  <span class="co"># Upper confidence interval</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(ks<span class="sc">$</span>Xf <span class="sc">-</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fu">sqrt</span>(ks<span class="sc">$</span>Pf), <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">col =</span> <span class="dv">4</span>)  <span class="co"># Lower confidence interval</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Smoothing Plot</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(Time, mu[<span class="sc">-</span><span class="dv">1</span>], <span class="at">main =</span> <span class="st">'Smooth'</span>, <span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">5</span>, <span class="dv">10</span>), <span class="at">xlab =</span> <span class="st">'Time'</span>, <span class="at">ylab =</span> <span class="st">'State'</span>)</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(ks<span class="sc">$</span>Xs, <span class="at">col =</span> <span class="st">'blue'</span>)  <span class="co"># Smoothed estimate</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(ks<span class="sc">$</span>Xs <span class="sc">+</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fu">sqrt</span>(ks<span class="sc">$</span>Ps), <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">col =</span> <span class="dv">4</span>)  <span class="co"># Upper confidence interval</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(ks<span class="sc">$</span>Xs <span class="sc">-</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fu">sqrt</span>(ks<span class="sc">$</span>Ps), <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">col =</span> <span class="dv">4</span>)  <span class="co"># Lower confidence interval</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="cap6_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="initial-state-information" class="level2" data-number="7.6">
<h2 data-number="7.6" class="anchored" data-anchor-id="initial-state-information"><span class="header-section-number">7.6</span> Initial State Information</h2>
<p>To display the initial value estimates and their uncertainty:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Initial state information</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>initial_mu <span class="ot">&lt;-</span> mu[<span class="dv">1</span>]</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>initial_estimate <span class="ot">&lt;-</span> ks<span class="sc">$</span>X0n</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>initial_uncertainty <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(ks<span class="sc">$</span>P0n)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>initial_mu</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -0.6264538</code></pre>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>initial_estimate</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           [,1]
[1,] -0.3241541</code></pre>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>initial_uncertainty</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          [,1]
[1,] 0.7861514</code></pre>
</div>
</div>
</section>
</section>
<section id="newton-raphson-for-ar1" class="level1" data-number="8">
<h1 data-number="8"><span class="header-section-number">8</span> Newton-Raphson for AR(1)</h1>
<p>Here’s the code in Rmarkdown format:</p>
<section id="data-generation-1" class="level2" data-number="8.1">
<h2 data-number="8.1" class="anchored" data-anchor-id="data-generation-1"><span class="header-section-number">8.1</span> Data Generation</h2>
<p>This code generates an AR(1) process with 100 observations and adds noise to simulate the observed series ( y ).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate Data</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">999</span>)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>num <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">arima.sim</span>(<span class="at">n =</span> num <span class="sc">+</span> <span class="dv">1</span>, <span class="fu">list</span>(<span class="at">ar =</span> <span class="fl">0.8</span>), <span class="at">sd =</span> <span class="dv">1</span>)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">ts</span>(x[<span class="sc">-</span><span class="dv">1</span>] <span class="sc">+</span> <span class="fu">rnorm</span>(num, <span class="dv">0</span>, <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="initial-parameter-estimates" class="level2" data-number="8.2">
<h2 data-number="8.2" class="anchored" data-anchor-id="initial-parameter-estimates"><span class="header-section-number">8.2</span> Initial Parameter Estimates</h2>
<p>We use lagged values of ( y ) to compute initial estimates for the parameters, including the AR coefficient ( ), process noise variance ( q ), and observation noise variance ( r ).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Initial Estimates</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>u <span class="ot">&lt;-</span> <span class="fu">ts.intersect</span>(y, <span class="fu">lag</span>(y, <span class="sc">-</span><span class="dv">1</span>), <span class="fu">lag</span>(y, <span class="sc">-</span><span class="dv">2</span>))</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>varu <span class="ot">&lt;-</span> <span class="fu">var</span>(u)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>coru <span class="ot">&lt;-</span> <span class="fu">cor</span>(u)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>phi <span class="ot">&lt;-</span> coru[<span class="dv">1</span>, <span class="dv">3</span>] <span class="sc">/</span> coru[<span class="dv">1</span>, <span class="dv">2</span>]</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>q <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">-</span> phi<span class="sc">^</span><span class="dv">2</span>) <span class="sc">*</span> varu[<span class="dv">1</span>, <span class="dv">2</span>] <span class="sc">/</span> phi</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>r <span class="ot">&lt;-</span> varu[<span class="dv">1</span>, <span class="dv">1</span>] <span class="sc">-</span> q <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> phi<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>(init.par <span class="ot">&lt;-</span> <span class="fu">c</span>(phi, <span class="fu">sqrt</span>(q), <span class="fu">sqrt</span>(r)))  <span class="co"># Initial parameter estimates: phi, sqrt(q), sqrt(r)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.9087024 0.5107053 1.0291205</code></pre>
</div>
</div>
</section>
<section id="likelihood-evaluation-function" class="level2" data-number="8.3">
<h2 data-number="8.3" class="anchored" data-anchor-id="likelihood-evaluation-function"><span class="header-section-number">8.3</span> Likelihood Evaluation Function</h2>
<p>The following function <code>Linn</code> evaluates the likelihood of the parameters using the Kalman filter. We initialize the Kalman filter with the variance of the process noise and observation noise.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to evaluate the likelihood</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>Linn <span class="ot">&lt;-</span> <span class="cf">function</span>(para) {</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  phi <span class="ot">&lt;-</span> para[<span class="dv">1</span>]</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  sigw <span class="ot">&lt;-</span> para[<span class="dv">2</span>]</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  sigv <span class="ot">&lt;-</span> para[<span class="dv">3</span>]</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>  Sigma0 <span class="ot">&lt;-</span> (sigw<span class="sc">^</span><span class="dv">2</span>) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> phi<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>  Sigma0[Sigma0 <span class="sc">&lt;</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>  kf <span class="ot">&lt;-</span> <span class="fu">Kfilter</span>(y, <span class="dv">1</span>, <span class="at">mu0 =</span> <span class="dv">0</span>, Sigma0, phi, sigw, sigv)</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(kf<span class="sc">$</span>like)</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="parameter-estimation" class="level2" data-number="8.4">
<h2 data-number="8.4" class="anchored" data-anchor-id="parameter-estimation"><span class="header-section-number">8.4</span> Parameter Estimation</h2>
<p>We use the <code>optim</code> function to estimate the parameters by maximizing the likelihood. The standard errors of the estimates are obtained from the inverse of the Hessian matrix.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimation</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>(est <span class="ot">&lt;-</span> <span class="fu">optim</span>(init.par, Linn, <span class="at">gr =</span> <span class="cn">NULL</span>, <span class="at">method =</span> <span class="st">'BFGS'</span>, <span class="at">hessian =</span> <span class="cn">TRUE</span>,</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>              <span class="at">control =</span> <span class="fu">list</span>(<span class="at">trace =</span> <span class="dv">1</span>, <span class="at">REPORT =</span> <span class="dv">1</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>initial  value 81.313627 
iter   2 value 80.169051
iter   3 value 79.866131
iter   4 value 79.222846
iter   5 value 79.021504
iter   6 value 79.014723
iter   7 value 79.014453
iter   7 value 79.014452
iter   7 value 79.014452
final  value 79.014452 
converged</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>$par
[1] 0.8137623 0.8507863 0.8743968

$value
[1] 79.01445

$counts
function gradient 
      23        7 

$convergence
[1] 0

$message
NULL

$hessian
          [,1]     [,2]     [,3]
[1,] 253.36290 67.39775 -9.64101
[2,]  67.39775 78.99067 48.61052
[3,]  -9.64101 48.61052 92.20472</code></pre>
</div>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>SE <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">diag</span>(<span class="fu">solve</span>(est<span class="sc">$</span>hessian)))</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cbind</span>(<span class="at">estimate =</span> <span class="fu">c</span>(<span class="at">phi =</span> est<span class="sc">$</span>par[<span class="dv">1</span>], <span class="at">sigw =</span> est<span class="sc">$</span>par[<span class="dv">2</span>], <span class="at">sigv =</span> est<span class="sc">$</span>par[<span class="dv">3</span>]), SE)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      estimate         SE
phi  0.8137623 0.08060636
sigw 0.8507863 0.17528895
sigv 0.8743968 0.14293192</code></pre>
</div>
</div>
<p>The output displays the final parameter estimates along with their standard errors, providing insight into the process and observation noise variances as well as the AR(1) coefficient ( ).</p>
</section>
</section>
<section id="kalman-filtering-and-smoothing-for-global-temperature-series" class="level1" data-number="9">
<h1 data-number="9"><span class="header-section-number">9</span> Kalman Filtering and Smoothing for Global Temperature Series</h1>
<section id="setup" class="level2" data-number="9.1">
<h2 data-number="9.1" class="anchored" data-anchor-id="setup"><span class="header-section-number">9.1</span> Setup</h2>
<p>This analysis uses two temperature series, <code>globtemp</code> and <code>globtempl</code>, to estimate underlying temperature deviations with Kalman filtering and smoothing. Initial parameters for the state-space model are defined below.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Setup</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">cbind</span>(gtemp_both, gtemp_land)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>num <span class="ot">&lt;-</span> <span class="fu">nrow</span>(y)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>input <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span>, num)</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>A <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="fu">rep</span>(<span class="dv">1</span>, <span class="dv">2</span>), <span class="at">dim =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">1</span>, num))</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>mu0 <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">0.35</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>Sigma0 <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>Phi <span class="ot">&lt;-</span> <span class="dv">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="function-to-calculate-likelihood" class="level2" data-number="9.2">
<h2 data-number="9.2" class="anchored" data-anchor-id="function-to-calculate-likelihood"><span class="header-section-number">9.2</span> Function to Calculate Likelihood</h2>
<p>The <code>Linn</code> function calculates the likelihood for given parameters using the Kalman filter.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to Calculate Likelihood</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>Linn <span class="ot">&lt;-</span> <span class="cf">function</span>(para) {</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  cQ <span class="ot">&lt;-</span> para[<span class="dv">1</span>]           <span class="co"># sigma_w</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  cR1 <span class="ot">&lt;-</span> para[<span class="dv">2</span>]          <span class="co"># 11 element of chol(R)</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  cR2 <span class="ot">&lt;-</span> para[<span class="dv">3</span>]          <span class="co"># 22 element of chol(R)</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  cR12 <span class="ot">&lt;-</span> para[<span class="dv">4</span>]         <span class="co"># 12 element of chol(R)</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  cR <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(cR1, <span class="dv">0</span>, cR12, cR2), <span class="dv">2</span>)  <span class="co"># covariance matrix</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>  drift <span class="ot">&lt;-</span> para[<span class="dv">5</span>]</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>  kf <span class="ot">&lt;-</span> <span class="fu">xKfilter1</span>(num,y, A, mu0, Sigma0, Phi, drift, <span class="dv">0</span>, cQ, cR, input)</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(kf<span class="sc">$</span>like)</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="parameter-estimation-1" class="level2" data-number="9.3">
<h2 data-number="9.3" class="anchored" data-anchor-id="parameter-estimation-1"><span class="header-section-number">9.3</span> Parameter Estimation</h2>
<p>Using the <code>optim</code> function, we estimate the parameters by maximizing the likelihood. Standard errors of the estimates are calculated from the inverse of the Hessian matrix.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimation</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>init.par <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.1</span>, <span class="fl">0.1</span>, <span class="fl">0.1</span>, <span class="dv">0</span>, <span class="fl">0.05</span>)  <span class="co"># initial parameter values</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>(est <span class="ot">&lt;-</span> <span class="fu">optim</span>(init.par, Linn, <span class="cn">NULL</span>, <span class="at">method =</span> <span class="st">'BFGS'</span>, <span class="at">hessian =</span> <span class="cn">TRUE</span>,</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>              <span class="at">control =</span> <span class="fu">list</span>(<span class="at">trace =</span> <span class="dv">1</span>, <span class="at">REPORT =</span> <span class="dv">1</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>initial  value 184.501891 
iter   2 value -159.432451
iter   3 value -188.554321
iter   4 value -200.890075
iter   5 value -208.848198
iter   6 value -211.409184
iter   7 value -213.558558
iter   8 value -214.769546
iter   9 value -267.916289
iter  10 value -297.895341
iter  11 value -303.034337
iter  12 value -307.209447
iter  13 value -308.047209
iter  14 value -309.192071
iter  15 value -325.458515
iter  16 value -334.450913
iter  17 value -346.813562
iter  18 value -353.434122
iter  19 value -355.968476
iter  20 value -358.279679
iter  21 value -359.654063
iter  22 value -360.828371
iter  23 value -362.830261
iter  24 value -363.103981
iter  25 value -363.773903
iter  26 value -364.968098
iter  27 value -365.043831
iter  28 value -365.049940
iter  29 value -365.049967
iter  29 value -365.049968
iter  29 value -365.049968
final  value -365.049968 
converged</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>$par
[1]  0.048049381 -0.174474017  0.202595173 -0.456845638  0.005039607

$value
[1] -365.05

$counts
function gradient 
     131       29 

$convergence
[1] 0

$message
NULL

$hessian
           [,1]      [,2]        [,3]        [,4]       [,5]
[1,] 13050.6563 -8050.631  3388.04295  2351.23616  -318.0862
[2,] -8050.6307 20385.258 -2341.69836 -6732.32604 -1584.6786
[3,]  3388.0429 -2341.698  4262.50590   -41.82895  -671.6387
[4,]  2351.2362 -6732.326   -41.82895  3213.88191   276.1468
[5,]  -318.0862 -1584.679  -671.63871   276.14678 73488.6243</code></pre>
</div>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>SE <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">diag</span>(<span class="fu">solve</span>(est<span class="sc">$</span>hessian)))</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>u <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="at">estimate =</span> est<span class="sc">$</span>par, SE)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(u) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'sigw'</span>, <span class="st">'cR11'</span>, <span class="st">'cR22'</span>, <span class="st">'cR12'</span>, <span class="st">'drift'</span>)</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>u  <span class="co"># Display estimates</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          estimate         SE
sigw   0.048049381 0.01097362
cR11  -0.174474017 0.01457017
cR22   0.202595173 0.01885251
cR12  -0.456845638 0.03498097
drift  0.005039607 0.00370230</code></pre>
</div>
</div>
</section>
<section id="smoothing" class="level2" data-number="9.4">
<h2 data-number="9.4" class="anchored" data-anchor-id="smoothing"><span class="header-section-number">9.4</span> Smoothing</h2>
<p>After estimating the parameters, we apply the Kalman smoother to obtain smoothed state estimates and their root mean square error.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Smooth (set parameters to their final estimates)</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>cQ <span class="ot">&lt;-</span> est<span class="sc">$</span>par[<span class="dv">1</span>]</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>cR1 <span class="ot">&lt;-</span> est<span class="sc">$</span>par[<span class="dv">2</span>]</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>cR2 <span class="ot">&lt;-</span> est<span class="sc">$</span>par[<span class="dv">3</span>]</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>cR12 <span class="ot">&lt;-</span> est<span class="sc">$</span>par[<span class="dv">4</span>]</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>cR <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(cR1, <span class="dv">0</span>, cR12, cR2), <span class="dv">2</span>)</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>(R <span class="ot">&lt;-</span> <span class="fu">t</span>(cR) <span class="sc">%*%</span> cR)  <span class="co"># Estimated R matrix</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           [,1]       [,2]
[1,] 0.03044118 0.07970769
[2,] 0.07970769 0.24975274</code></pre>
</div>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>drift <span class="ot">&lt;-</span> est<span class="sc">$</span>par[<span class="dv">5</span>]</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>ks <span class="ot">&lt;-</span> <span class="fu">xKsmooth1</span>(num, y, A, mu0, Sigma0, Phi, drift, <span class="dv">0</span>, cQ, cR, input)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="plotting-results" class="level2" data-number="9.5">
<h2 data-number="9.5" class="anchored" data-anchor-id="plotting-results"><span class="header-section-number">9.5</span> Plotting Results</h2>
<p>The smoothed state estimates are plotted with a confidence interval, along with the original series for comparison.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>xsm <span class="ot">&lt;-</span> <span class="fu">ts</span>(<span class="fu">as.vector</span>(ks<span class="sc">$</span>xs), <span class="at">start =</span> <span class="dv">1850</span>)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>rmse <span class="ot">&lt;-</span> <span class="fu">ts</span>(<span class="fu">sqrt</span>(<span class="fu">as.vector</span>(ks<span class="sc">$</span>Ps)), <span class="at">start =</span> <span class="dv">1850</span>)</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(xsm, <span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.6</span>, <span class="dv">1</span>), <span class="at">ylab =</span> <span class="st">'Temperature Deviations'</span>, <span class="at">main =</span> <span class="st">'Smoothed Temperature Deviations'</span>)</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>xx <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">time</span>(xsm), <span class="fu">rev</span>(<span class="fu">time</span>(xsm)))</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>yy <span class="ot">&lt;-</span> <span class="fu">c</span>(xsm <span class="sc">-</span> <span class="dv">2</span> <span class="sc">*</span> rmse, <span class="fu">rev</span>(xsm <span class="sc">+</span> <span class="dv">2</span> <span class="sc">*</span> rmse))</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="fu">polygon</span>(xx, yy, <span class="at">border =</span> <span class="cn">NA</span>, <span class="at">col =</span> <span class="fu">gray</span>(<span class="fl">0.6</span>, <span class="at">alpha =</span> <span class="fl">0.25</span>))  <span class="co"># Confidence interval</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Original series for comparison</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(gtemp_both, <span class="at">type =</span> <span class="st">'o'</span>, <span class="at">pch =</span> <span class="dv">2</span>, <span class="at">col =</span> <span class="dv">4</span>, <span class="at">lty =</span> <span class="dv">6</span>)</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(gtemp_land, <span class="at">type =</span> <span class="st">'o'</span>, <span class="at">pch =</span> <span class="dv">3</span>, <span class="at">col =</span> <span class="dv">3</span>, <span class="at">lty =</span> <span class="dv">6</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="cap6_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Here’s an Rmarkdown version summarizing the EM algorithm estimation and associated code:</p>
</section>
</section>
<section id="em-algorithm-estimation-for-ar1-model-parameters" class="level1" data-number="10">
<h1 data-number="10"><span class="header-section-number">10</span> EM Algorithm Estimation for AR(1) Model Parameters</h1>
<section id="introduction-3" class="level2" data-number="10.1">
<h2 data-number="10.1" class="anchored" data-anchor-id="introduction-3"><span class="header-section-number">10.1</span> Introduction</h2>
<p>Using the same data generated in Example 6.6, we perform an EM algorithm to estimate the parameters ( ), ( _w^2 ), ( _v^2 ), as well as the initial parameters ( _0 ) and ( _0 ). The EM algorithm converges when the relative change in log likelihood is less than 0.00001, taking 59 iterations in this case. The final estimates and their standard errors are calculated using <code>fdHess</code> from the <code>nlme</code> package to evaluate the Hessian at the final estimates.</p>
</section>
<section id="load-required-package" class="level2" data-number="10.2">
<h2 data-number="10.2" class="anchored" data-anchor-id="load-required-package"><span class="header-section-number">10.2</span> Load Required Package</h2>
<p>To calculate standard errors, we use the <code>nlme</code> package for evaluating the Hessian matrix.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load nlme package</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(nlme)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="data-generation-2" class="level2" data-number="10.3">
<h2 data-number="10.3" class="anchored" data-anchor-id="data-generation-2"><span class="header-section-number">10.3</span> Data Generation</h2>
<p>We generate data for a local level model with an AR(1) process, as in Example 6.6.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate data (same as Example 6.6)</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">999</span>)</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>num <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">arima.sim</span>(<span class="at">n =</span> num <span class="sc">+</span> <span class="dv">1</span>, <span class="fu">list</span>(<span class="at">ar =</span> <span class="fl">0.8</span>), <span class="at">sd =</span> <span class="dv">1</span>)</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">ts</span>(x[<span class="sc">-</span><span class="dv">1</span>] <span class="sc">+</span> <span class="fu">rnorm</span>(num, <span class="dv">0</span>, <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="initial-parameter-estimates-1" class="level2" data-number="10.4">
<h2 data-number="10.4" class="anchored" data-anchor-id="initial-parameter-estimates-1"><span class="header-section-number">10.4</span> Initial Parameter Estimates</h2>
<p>Initial estimates for the parameters are calculated based on lagged values of ( y ).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Initial Estimates</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>u <span class="ot">&lt;-</span> <span class="fu">ts.intersect</span>(y, <span class="fu">lag</span>(y, <span class="sc">-</span><span class="dv">1</span>), <span class="fu">lag</span>(y, <span class="sc">-</span><span class="dv">2</span>))</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>varu <span class="ot">&lt;-</span> <span class="fu">var</span>(u)</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>coru <span class="ot">&lt;-</span> <span class="fu">cor</span>(u)</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>phi <span class="ot">&lt;-</span> coru[<span class="dv">1</span>, <span class="dv">3</span>] <span class="sc">/</span> coru[<span class="dv">1</span>, <span class="dv">2</span>]</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>q <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">-</span> phi<span class="sc">^</span><span class="dv">2</span>) <span class="sc">*</span> varu[<span class="dv">1</span>, <span class="dv">2</span>] <span class="sc">/</span> phi</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>r <span class="ot">&lt;-</span> varu[<span class="dv">1</span>, <span class="dv">1</span>] <span class="sc">-</span> q <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> phi<span class="sc">^</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="em-algorithm-procedure" class="level2" data-number="10.5">
<h2 data-number="10.5" class="anchored" data-anchor-id="em-algorithm-procedure"><span class="header-section-number">10.5</span> EM Algorithm Procedure</h2>
<p>We use the <code>EM0</code> function to run the EM algorithm, specifying the tolerance level and maximum iterations for convergence.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Run EM algorithm</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>em <span class="ot">&lt;-</span> <span class="fu">EM</span>(y, <span class="at">A =</span> <span class="dv">1</span>, <span class="at">mu0 =</span> <span class="dv">0</span>, <span class="at">Sigma0 =</span> <span class="fl">2.8</span>, <span class="at">Phi =</span> phi, <span class="at">Q =</span> <span class="fu">sqrt</span>(q), <span class="at">R =</span> <span class="fu">sqrt</span>(r),</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>          <span class="at">max.iter =</span> <span class="dv">75</span>, <span class="at">tol =</span> .<span class="dv">00001</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>iteration    -loglikelihood 
    1          80.06323 
    2          78.91486 
    3          78.69396 
    4          78.56839 
    5          78.47927 
    6          78.40996 
    7          78.35368 
    8          78.30696 
    9          78.2677 
    10          78.23446 
    11          78.20617 
    12          78.18201 
    13          78.1613 
    14          78.14349 
    15          78.12813 
    16          78.11485 
    17          78.10333 
    18          78.09331 
    19          78.08456 
    20          78.07689 
    21          78.07015 
    22          78.06421 
    23          78.05895 
    24          78.05428 
    25          78.05011 
    26          78.04637 
    27          78.04302 
    28          78.04 
    29          78.03726 
    30          78.03477 
    31          78.03251 
    32          78.03044 
    33          78.02853 
    34          78.02678 
    35          78.02517 
    36          78.02367 
    37          78.02228 
    38          78.02099 
    39          78.01978 
    40          78.01865 
    41          78.0176 
    42          78.0166 
    43          78.01567 
    44          78.01478 
    45          78.01395 
    46          78.01316 
    47          78.01241 </code></pre>
</div>
</div>
</section>
<section id="calculation-of-standard-errors" class="level2" data-number="10.6">
<h2 data-number="10.6" class="anchored" data-anchor-id="calculation-of-standard-errors"><span class="header-section-number">10.6</span> Calculation of Standard Errors</h2>
<p>Using <code>fdHess</code> from the <code>nlme</code> package, we calculate the standard errors based on the Hessian of the log-likelihood at the final parameter estimates.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Standard Errors using fdHess</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>phi <span class="ot">&lt;-</span> em<span class="sc">$</span>Phi</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>cq <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(em<span class="sc">$</span>Q)</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>cr <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(em<span class="sc">$</span>R)</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>mu0 <span class="ot">&lt;-</span> em<span class="sc">$</span>mu0</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>Sigma0 <span class="ot">&lt;-</span> em<span class="sc">$</span>Sigma0</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>para <span class="ot">&lt;-</span> <span class="fu">c</span>(phi, cq, cr)</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Define likelihood function</span></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>Linn <span class="ot">&lt;-</span> <span class="cf">function</span>(para) {</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>  kf <span class="ot">&lt;-</span> <span class="fu">Kfilter</span>(y, <span class="dv">1</span>, mu0, Sigma0, para[<span class="dv">1</span>], para[<span class="dv">2</span>], para[<span class="dv">3</span>])</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(kf<span class="sc">$</span>like)</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate Hessian and calculate standard errors</span></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>emhess <span class="ot">&lt;-</span> <span class="fu">fdHess</span>(para, <span class="cf">function</span>(para) <span class="fu">Linn</span>(para))</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>SE <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">diag</span>(<span class="fu">solve</span>(emhess<span class="sc">$</span>Hessian)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="summary-of-final-estimates" class="level2" data-number="10.7">
<h2 data-number="10.7" class="anchored" data-anchor-id="summary-of-final-estimates"><span class="header-section-number">10.7</span> Summary of Final Estimates</h2>
<p>The table below shows the final estimates from the EM algorithm along with their standard errors.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Display Summary of Estimation</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>estimate <span class="ot">&lt;-</span> <span class="fu">c</span>(para, em<span class="sc">$</span>mu0, em<span class="sc">$</span>Sigma0)</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>SE <span class="ot">&lt;-</span> <span class="fu">c</span>(SE, <span class="cn">NA</span>, <span class="cn">NA</span>)  <span class="co"># No standard errors for mu0 and Sigma0</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>u <span class="ot">&lt;-</span> <span class="fu">cbind</span>(estimate, SE)</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(u) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'phi'</span>, <span class="st">'sigw'</span>, <span class="st">'sigv'</span>, <span class="st">'mu0'</span>, <span class="st">'Sigma0'</span>)</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>u  <span class="co"># Display results</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          estimate         SE
phi     0.80770475 0.07827525
sigw    0.85642590 0.16295337
sigv    0.86107346 0.13644243
mu0    -2.10378197         NA
Sigma0  0.03807792         NA</code></pre>
</div>
</div>
</section>
</section>
<section id="em-algorithm-for-multivariate-biomedical-data-missing-data" class="level1" data-number="11">
<h1 data-number="11"><span class="header-section-number">11</span> EM Algorithm for Multivariate Biomedical Data (missing data)</h1>
<section id="introduction-4" class="level2" data-number="11.1">
<h2 data-number="11.1" class="anchored" data-anchor-id="introduction-4"><span class="header-section-number">11.1</span> Introduction</h2>
<p>This analysis uses the EM algorithm to estimate parameters for a multivariate time series model involving three biomedical markers: <strong>WBC</strong>, <strong>PLT</strong>, and <strong>HCT</strong>. After estimating parameters, we apply a Kalman smoother to obtain smoothed values and their confidence intervals.</p>
</section>
<section id="data-setup" class="level2" data-number="11.2">
<h2 data-number="11.2" class="anchored" data-anchor-id="data-setup"><span class="header-section-number">11.2</span> Data Setup</h2>
<p>We begin by organizing the observed data into a matrix and setting up an array of observation matrices for the Kalman filter.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine data into a matrix</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">cbind</span>(WBC, PLT, HCT)</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>num <span class="ot">&lt;-</span> <span class="fu">nrow</span>(y)</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Create array of observation matrices</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>A <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="at">dim =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">3</span>, num))</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>num) {</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (y[k, <span class="dv">1</span>] <span class="sc">&gt;</span> <span class="dv">0</span>) A[, , k] <span class="ot">&lt;-</span> <span class="fu">diag</span>(<span class="dv">1</span>, <span class="dv">3</span>)  <span class="co"># Observation matrix if data is available</span></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="initial-parameter-values" class="level2" data-number="11.3">
<h2 data-number="11.3" class="anchored" data-anchor-id="initial-parameter-values"><span class="header-section-number">11.3</span> Initial Parameter Values</h2>
<p>We define the initial values for the state vector, covariance matrices, and model parameters.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Initial values</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>mu0 <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="dv">3</span>, <span class="dv">1</span>)                <span class="co"># Initial state mean vector</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>Sigma0 <span class="ot">&lt;-</span> <span class="fu">diag</span>(<span class="fu">c</span>(<span class="fl">0.1</span>, <span class="fl">0.1</span>, <span class="dv">1</span>), <span class="dv">3</span>)     <span class="co"># Initial state covariance</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>Phi <span class="ot">&lt;-</span> <span class="fu">diag</span>(<span class="dv">1</span>, <span class="dv">3</span>)                     <span class="co"># State transition matrix</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>cQ <span class="ot">&lt;-</span> <span class="fu">diag</span>(<span class="fu">c</span>(<span class="fl">0.1</span>, <span class="fl">0.1</span>, <span class="dv">1</span>), <span class="dv">3</span>)         <span class="co"># Process noise covariance matrix</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>cR <span class="ot">&lt;-</span> <span class="fu">diag</span>(<span class="fu">c</span>(<span class="fl">0.1</span>, <span class="fl">0.1</span>, <span class="dv">1</span>), <span class="dv">3</span>)         <span class="co"># Observation noise covariance matrix</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="em-algorithm-procedure-1" class="level2" data-number="11.4">
<h2 data-number="11.4" class="anchored" data-anchor-id="em-algorithm-procedure-1"><span class="header-section-number">11.4</span> EM Algorithm Procedure</h2>
<p>We run the EM algorithm using the <code>EM1</code> function, specifying the maximum iterations and tolerance for convergence.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Run EM algorithm</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>em <span class="ot">&lt;-</span> <span class="fu">xEM1</span>(num, y, A, mu0, Sigma0, Phi, cQ, cR, <span class="dv">100</span>, <span class="fl">0.001</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>iteration    -loglikelihood 
    1          68.28328 
    2          -183.9361 
    3          -194.2051 
    4          -197.5444 
    5          -199.7442 
    6          -201.6431 
    7          -203.4226 
    8          -205.1253 
    9          -206.7595 
    10          -208.3251 
    11          -209.8209 
    12          -211.2464 
    13          -212.602 
    14          -213.8891 
    15          -215.1094 
    16          -216.2651 
    17          -217.3589 
    18          -218.3931 
    19          -219.3705 
    20          -220.2935 
    21          -221.1649 
    22          -221.9869 
    23          -222.762 
    24          -223.4924 
    25          -224.1805 
    26          -224.8282 
    27          -225.4377 
    28          -226.0109 
    29          -226.5495 
    30          -227.0555 
    31          -227.5305 
    32          -227.9762 
    33          -228.3941 
    34          -228.7857 
    35          -229.1524 
    36          -229.4956 
    37          -229.8166 
    38          -230.1166 
    39          -230.3967 
    40          -230.6582 
    41          -230.9019 
    42          -231.1289 </code></pre>
</div>
</div>
</section>
<section id="smoothing-with-kalman-smoother" class="level2" data-number="11.5">
<h2 data-number="11.5" class="anchored" data-anchor-id="smoothing-with-kalman-smoother"><span class="header-section-number">11.5</span> Smoothing with Kalman Smoother</h2>
<p>Using the estimated parameters from the EM algorithm, we apply the Kalman smoother to obtain smoothed estimates and their uncertainties.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply Kalman smoother</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>ks <span class="ot">&lt;-</span> <span class="fu">xKsmooth1</span>(num, y, A, em<span class="sc">$</span>mu0, em<span class="sc">$</span>Sigma0, em<span class="sc">$</span>Phi, <span class="dv">0</span>, <span class="dv">0</span>, <span class="fu">chol</span>(em<span class="sc">$</span>Q), <span class="fu">chol</span>(em<span class="sc">$</span>R), <span class="dv">0</span>)</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract smoothed estimates and uncertainties</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>y1s <span class="ot">&lt;-</span> ks<span class="sc">$</span>xs[<span class="dv">1</span>, , ]</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>y2s <span class="ot">&lt;-</span> ks<span class="sc">$</span>xs[<span class="dv">2</span>, , ]</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>y3s <span class="ot">&lt;-</span> ks<span class="sc">$</span>xs[<span class="dv">3</span>, , ]</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fu">sqrt</span>(ks<span class="sc">$</span>Ps[<span class="dv">1</span>, <span class="dv">1</span>, ])</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fu">sqrt</span>(ks<span class="sc">$</span>Ps[<span class="dv">2</span>, <span class="dv">2</span>, ])</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fu">sqrt</span>(ks<span class="sc">$</span>Ps[<span class="dv">3</span>, <span class="dv">3</span>, ])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="plotting-results-1" class="level2" data-number="11.6">
<h2 data-number="11.6" class="anchored" data-anchor-id="plotting-results-1"><span class="header-section-number">11.6</span> Plotting Results</h2>
<p>The plots below show the original data for each marker along with the smoothed estimates and 95% confidence intervals.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot smoothed estimates and confidence intervals</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">1</span>))</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot for WBC</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(WBC, <span class="at">type =</span> <span class="st">'p'</span>, <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">5</span>), <span class="at">xlab =</span> <span class="st">'day'</span>, <span class="at">ylab =</span> <span class="st">'WBC'</span>)</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(y1s, <span class="at">col =</span> <span class="st">'blue'</span>)  <span class="co"># Smoothed estimate</span></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(y1s <span class="sc">+</span> p1, <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">col =</span> <span class="dv">4</span>)  <span class="co"># Upper confidence bound</span></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(y1s <span class="sc">-</span> p1, <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">col =</span> <span class="dv">4</span>)  <span class="co"># Lower confidence bound</span></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot for PLT</span></span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(PLT, <span class="at">type =</span> <span class="st">'p'</span>, <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">6</span>), <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">xlab =</span> <span class="st">'day'</span>, <span class="at">ylab =</span> <span class="st">'PLT'</span>)</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(y2s, <span class="at">col =</span> <span class="st">'blue'</span>)  <span class="co"># Smoothed estimate</span></span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(y2s <span class="sc">+</span> p2, <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">col =</span> <span class="dv">4</span>)  <span class="co"># Upper confidence bound</span></span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(y2s <span class="sc">-</span> p2, <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">col =</span> <span class="dv">4</span>)  <span class="co"># Lower confidence bound</span></span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot for HCT</span></span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(HCT, <span class="at">type =</span> <span class="st">'p'</span>, <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">20</span>, <span class="dv">40</span>), <span class="at">xlab =</span> <span class="st">'day'</span>, <span class="at">ylab =</span> <span class="st">'HCT'</span>)</span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(y3s, <span class="at">col =</span> <span class="st">'blue'</span>)  <span class="co"># Smoothed estimate</span></span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(y3s <span class="sc">+</span> p3, <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">col =</span> <span class="dv">4</span>)  <span class="co"># Upper confidence bound</span></span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(y3s <span class="sc">-</span> p3, <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">col =</span> <span class="dv">4</span>)  <span class="co"># Lower confidence bound</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="cap6_files/figure-html/unnamed-chunk-26-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="structural-models-parameter-estimation-and-smoothing-for-jj-time-series" class="level1" data-number="12">
<h1 data-number="12"><span class="header-section-number">12</span> Structural Models: Parameter Estimation and Smoothing for J&amp;J Time Series</h1>
<section id="introduction-5" class="level2" data-number="12.1">
<h2 data-number="12.1" class="anchored" data-anchor-id="introduction-5"><span class="header-section-number">12.1</span> Introduction</h2>
<p>This analysis uses a state-space model to estimate the trend and seasonal components of the Johnson &amp; Johnson (J&amp;J) quarterly earnings per share. The estimation procedure uses the Kalman filter and smoother, and forecasts are generated for the future values. The model parameters are estimated using maximum likelihood and the <code>optim</code> function.</p>
</section>
<section id="setup-1" class="level2" data-number="12.2">
<h2 data-number="12.2" class="anchored" data-anchor-id="setup-1"><span class="header-section-number">12.2</span> Setup</h2>
<p>We start by setting up the observation matrix ( A ), the initial state mean ( _0 ), and covariance ( _0 ).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Setup</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>num <span class="ot">&lt;-</span> <span class="fu">length</span>(jj)  <span class="co"># Length of the time series data</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>A <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>)  <span class="co"># Observation matrix</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Initial Parameters</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>mu0 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.7</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>)              <span class="co"># Initial state mean vector</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>Sigma0 <span class="ot">&lt;-</span> <span class="fu">diag</span>(<span class="fl">0.04</span>, <span class="dv">4</span>)             <span class="co"># Initial state covariance matrix</span></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>init.par <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">1.03</span>, <span class="fl">0.1</span>, <span class="fl">0.1</span>, <span class="fl">0.5</span>)  <span class="co"># Initial estimates for parameters</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="likelihood-function" class="level2" data-number="12.3">
<h2 data-number="12.3" class="anchored" data-anchor-id="likelihood-function"><span class="header-section-number">12.3</span> Likelihood Function</h2>
<p>The <code>Linn</code> function calculates the likelihood for given parameters using the Kalman filter. It takes the parameters ( ), ( _w ) for process noise, and ( _v ) for observation noise.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to Calculate Likelihood</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>Linn <span class="ot">&lt;-</span> <span class="cf">function</span>(para) {</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>  Phi <span class="ot">&lt;-</span> <span class="fu">diag</span>(<span class="dv">0</span>, <span class="dv">4</span>)</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>  Phi[<span class="dv">1</span>, <span class="dv">1</span>] <span class="ot">&lt;-</span> para[<span class="dv">1</span>]</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>  Phi[<span class="dv">2</span>, ] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="sc">-</span><span class="dv">1</span>, <span class="sc">-</span><span class="dv">1</span>, <span class="sc">-</span><span class="dv">1</span>)</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>  Phi[<span class="dv">3</span>, ] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>)</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>  Phi[<span class="dv">4</span>, ] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>  cQ1 <span class="ot">&lt;-</span> para[<span class="dv">2</span>]</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>  cQ2 <span class="ot">&lt;-</span> para[<span class="dv">3</span>]</span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>  cQ <span class="ot">&lt;-</span> <span class="fu">diag</span>(<span class="dv">0</span>, <span class="dv">4</span>)</span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>  cQ[<span class="dv">1</span>, <span class="dv">1</span>] <span class="ot">&lt;-</span> cQ1</span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>  cQ[<span class="dv">2</span>, <span class="dv">2</span>] <span class="ot">&lt;-</span> cQ2</span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>  cR <span class="ot">&lt;-</span> para[<span class="dv">4</span>]</span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a>  kf <span class="ot">&lt;-</span> <span class="fu">xKfilter0</span>(num, jj, A, mu0, Sigma0, Phi, cQ, cR)</span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(kf<span class="sc">$</span>like)</span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="parameter-estimation-2" class="level2" data-number="12.4">
<h2 data-number="12.4" class="anchored" data-anchor-id="parameter-estimation-2"><span class="header-section-number">12.4</span> Parameter Estimation</h2>
<p>Using the <code>optim</code> function, we estimate the parameters by maximizing the likelihood, and calculate standard errors.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimation</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>est <span class="ot">&lt;-</span> <span class="fu">optim</span>(init.par, Linn, <span class="cn">NULL</span>, <span class="at">method =</span> <span class="st">'BFGS'</span>, <span class="at">hessian =</span> <span class="cn">TRUE</span>,</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>             <span class="at">control =</span> <span class="fu">list</span>(<span class="at">trace =</span> <span class="dv">1</span>, <span class="at">REPORT =</span> <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>initial  value 2.693644 
iter   2 value -0.853526
iter   3 value -9.416505
iter   4 value -10.241752
iter   5 value -19.419809
iter   6 value -30.441188
iter   7 value -31.825543
iter   8 value -32.248413
iter   9 value -32.839918
iter  10 value -33.019870
iter  11 value -33.041749
iter  12 value -33.050583
iter  13 value -33.055492
iter  14 value -33.078152
iter  15 value -33.096870
iter  16 value -33.098405
iter  17 value -33.099018
iter  18 value -33.099385
iter  19 value -33.099498
iter  19 value -33.099498
final  value -33.099498 
converged</code></pre>
</div>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>SE <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">diag</span>(<span class="fu">solve</span>(est<span class="sc">$</span>hessian)))</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>u <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="at">estimate =</span> est<span class="sc">$</span>par, SE)</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(u) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'Phi11'</span>, <span class="st">'sigw1'</span>, <span class="st">'sigw2'</span>, <span class="st">'sigv'</span>)</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>u  <span class="co"># Display results</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          estimate         SE
Phi11 1.0350847657 0.00253645
sigw1 0.1397255477 0.02155155
sigw2 0.2208782663 0.02376430
sigv  0.0004655672 0.24174702</code></pre>
</div>
</div>
</section>
<section id="smoothing-with-kalman-smoother-1" class="level2" data-number="12.5">
<h2 data-number="12.5" class="anchored" data-anchor-id="smoothing-with-kalman-smoother-1"><span class="header-section-number">12.5</span> Smoothing with Kalman Smoother</h2>
<p>We apply the Kalman smoother with the estimated parameters to extract the trend and seasonal components.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Smooth</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>Phi <span class="ot">&lt;-</span> <span class="fu">diag</span>(<span class="dv">0</span>, <span class="dv">4</span>)</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>Phi[<span class="dv">1</span>, <span class="dv">1</span>] <span class="ot">&lt;-</span> est<span class="sc">$</span>par[<span class="dv">1</span>]</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>Phi[<span class="dv">2</span>, ] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="sc">-</span><span class="dv">1</span>, <span class="sc">-</span><span class="dv">1</span>, <span class="sc">-</span><span class="dv">1</span>)</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>Phi[<span class="dv">3</span>, ] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>)</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>Phi[<span class="dv">4</span>, ] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>cQ1 <span class="ot">&lt;-</span> est<span class="sc">$</span>par[<span class="dv">2</span>]</span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>cQ2 <span class="ot">&lt;-</span> est<span class="sc">$</span>par[<span class="dv">3</span>]</span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>cQ <span class="ot">&lt;-</span> <span class="fu">diag</span>(<span class="dv">1</span>, <span class="dv">4</span>)</span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>cQ[<span class="dv">1</span>, <span class="dv">1</span>] <span class="ot">&lt;-</span> cQ1</span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>cQ[<span class="dv">2</span>, <span class="dv">2</span>] <span class="ot">&lt;-</span> cQ2</span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>cR <span class="ot">&lt;-</span> est<span class="sc">$</span>par[<span class="dv">4</span>]</span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a>ks <span class="ot">&lt;-</span> <span class="fu">xKsmooth0</span>(num, jj, A, mu0, Sigma0, Phi, cQ, cR)</span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract trend and seasonal components</span></span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a>Tsm <span class="ot">&lt;-</span> <span class="fu">ts</span>(ks<span class="sc">$</span>xs[<span class="dv">1</span>, , ], <span class="at">start =</span> <span class="dv">1960</span>, <span class="at">freq =</span> <span class="dv">4</span>)</span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a>Ssm <span class="ot">&lt;-</span> <span class="fu">ts</span>(ks<span class="sc">$</span>xs[<span class="dv">2</span>, , ], <span class="at">start =</span> <span class="dv">1960</span>, <span class="at">freq =</span> <span class="dv">4</span>)</span>
<span id="cb52-20"><a href="#cb52-20" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="dv">3</span> <span class="sc">*</span> <span class="fu">sqrt</span>(ks<span class="sc">$</span>Ps[<span class="dv">1</span>, <span class="dv">1</span>, ])</span>
<span id="cb52-21"><a href="#cb52-21" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="dv">3</span> <span class="sc">*</span> <span class="fu">sqrt</span>(ks<span class="sc">$</span>Ps[<span class="dv">2</span>, <span class="dv">2</span>, ])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="plotting-results-2" class="level2" data-number="12.6">
<h2 data-number="12.6" class="anchored" data-anchor-id="plotting-results-2"><span class="header-section-number">12.6</span> Plotting Results</h2>
<p>The plots show the trend component and the J&amp;J quarterly earnings per share with the estimated trend and seasonal components.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot trend component and J&amp;J data with confidence intervals</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">1</span>))</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Trend component plot</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(Tsm, <span class="at">main =</span> <span class="st">'Trend Component'</span>, <span class="at">ylab =</span> <span class="st">'Trend'</span>)</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>xx <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">time</span>(jj), <span class="fu">rev</span>(<span class="fu">time</span>(jj)))</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>yy <span class="ot">&lt;-</span> <span class="fu">c</span>(Tsm <span class="sc">-</span> p1, <span class="fu">rev</span>(Tsm <span class="sc">+</span> p1))</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a><span class="fu">polygon</span>(xx, yy, <span class="at">border =</span> <span class="cn">NA</span>, <span class="at">col =</span> <span class="fu">gray</span>(<span class="fl">0.5</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>))</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Data and trend + season plot</span></span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(jj, <span class="at">main =</span> <span class="st">'Data &amp; Trend+Season'</span>, <span class="at">ylab =</span> <span class="st">'J&amp;J QE/Share'</span>, <span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.5</span>, <span class="dv">17</span>))</span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>xx <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">time</span>(jj), <span class="fu">rev</span>(<span class="fu">time</span>(jj)))</span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>yy <span class="ot">&lt;-</span> <span class="fu">c</span>((Tsm <span class="sc">+</span> Ssm) <span class="sc">-</span> (p1 <span class="sc">+</span> p2), <span class="fu">rev</span>((Tsm <span class="sc">+</span> Ssm) <span class="sc">+</span> (p1 <span class="sc">+</span> p2)))</span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a><span class="fu">polygon</span>(xx, yy, <span class="at">border =</span> <span class="cn">NA</span>, <span class="at">col =</span> <span class="fu">gray</span>(<span class="fl">0.5</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="cap6_files/figure-html/unnamed-chunk-31-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="forecasting" class="level2" data-number="12.7">
<h2 data-number="12.7" class="anchored" data-anchor-id="forecasting"><span class="header-section-number">12.7</span> Forecasting</h2>
<p>The following code generates forecasts for the next 12 quarters, showing the forecast values with confidence intervals.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Forecast</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>n.ahead <span class="ot">&lt;-</span> <span class="dv">12</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">ts</span>(<span class="fu">append</span>(jj, <span class="fu">rep</span>(<span class="dv">0</span>, n.ahead)), <span class="at">start =</span> <span class="dv">1960</span>, <span class="at">freq =</span> <span class="dv">4</span>)</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>rmspe <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, n.ahead)</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>x00 <span class="ot">&lt;-</span> ks<span class="sc">$</span>xf[ , , num]</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>P00 <span class="ot">&lt;-</span> ks<span class="sc">$</span>Pf[ , , num]</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>Q <span class="ot">&lt;-</span> <span class="fu">t</span>(cQ) <span class="sc">%*%</span> cQ</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>R <span class="ot">&lt;-</span> <span class="fu">t</span>(cR) <span class="sc">%*%</span> cR</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (m <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n.ahead) {</span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>  xp <span class="ot">&lt;-</span> Phi <span class="sc">%*%</span> x00</span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>  Pp <span class="ot">&lt;-</span> Phi <span class="sc">%*%</span> P00 <span class="sc">%*%</span> <span class="fu">t</span>(Phi) <span class="sc">+</span> Q</span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>  sig <span class="ot">&lt;-</span> A <span class="sc">%*%</span> Pp <span class="sc">%*%</span> <span class="fu">t</span>(A) <span class="sc">+</span> R</span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a>  K <span class="ot">&lt;-</span> Pp <span class="sc">%*%</span> <span class="fu">t</span>(A) <span class="sc">%*%</span> (<span class="dv">1</span> <span class="sc">/</span> sig)</span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a>  x00 <span class="ot">&lt;-</span> xp</span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a>  P00 <span class="ot">&lt;-</span> Pp <span class="sc">-</span> K <span class="sc">%*%</span> A <span class="sc">%*%</span> Pp</span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a>  y[num <span class="sc">+</span> m] <span class="ot">&lt;-</span> A <span class="sc">%*%</span> xp</span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a>  rmspe[m] <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(sig)</span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-21"><a href="#cb54-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Forecast plot</span></span>
<span id="cb54-22"><a href="#cb54-22" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(y, <span class="at">type =</span> <span class="st">'o'</span>, <span class="at">main =</span> <span class="st">''</span>, <span class="at">ylab =</span> <span class="st">'J&amp;J QE/Share'</span>, <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">30</span>),</span>
<span id="cb54-23"><a href="#cb54-23" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">1975</span>, <span class="dv">1984</span>))</span>
<span id="cb54-24"><a href="#cb54-24" aria-hidden="true" tabindex="-1"></a>upp <span class="ot">&lt;-</span> <span class="fu">ts</span>(y[(num <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(num <span class="sc">+</span> n.ahead)] <span class="sc">+</span> <span class="dv">2</span> <span class="sc">*</span> rmspe, <span class="at">start =</span> <span class="dv">1981</span>, <span class="at">freq =</span> <span class="dv">4</span>)</span>
<span id="cb54-25"><a href="#cb54-25" aria-hidden="true" tabindex="-1"></a>low <span class="ot">&lt;-</span> <span class="fu">ts</span>(y[(num <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(num <span class="sc">+</span> n.ahead)] <span class="sc">-</span> <span class="dv">2</span> <span class="sc">*</span> rmspe, <span class="at">start =</span> <span class="dv">1981</span>, <span class="at">freq =</span> <span class="dv">4</span>)</span>
<span id="cb54-26"><a href="#cb54-26" aria-hidden="true" tabindex="-1"></a>xx <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">time</span>(low), <span class="fu">rev</span>(<span class="fu">time</span>(upp)))</span>
<span id="cb54-27"><a href="#cb54-27" aria-hidden="true" tabindex="-1"></a>yy <span class="ot">&lt;-</span> <span class="fu">c</span>(low, <span class="fu">rev</span>(upp))</span>
<span id="cb54-28"><a href="#cb54-28" aria-hidden="true" tabindex="-1"></a><span class="fu">polygon</span>(xx, yy, <span class="at">border =</span> <span class="dv">8</span>, <span class="at">col =</span> <span class="fu">gray</span>(<span class="fl">0.5</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>))</span>
<span id="cb54-29"><a href="#cb54-29" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v =</span> <span class="dv">1981</span>, <span class="at">lty =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="cap6_files/figure-html/unnamed-chunk-32-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="stochastic-regression" class="level1" data-number="13">
<h1 data-number="13"><span class="header-section-number">13</span> Stochastic Regression</h1>
<section id="introduction-6" class="level2" data-number="13.1">
<h2 data-number="13.1" class="anchored" data-anchor-id="introduction-6"><span class="header-section-number">13.1</span> Introduction</h2>
<p>This analysis uses a state-space model to estimate parameters for inflation (<code>qinfl</code>) and interest rate (<code>qintr</code>) time series data. We use the Kalman filter to estimate the parameters and bootstrap to assess the variability of estimates. The <code>plyr</code> package is used to display progress, and <code>psych</code> is used for plotting with <code>scatter.hist</code>.</p>
</section>
<section id="setup-2" class="level2" data-number="13.2">
<h2 data-number="13.2" class="anchored" data-anchor-id="setup-2"><span class="header-section-number">13.2</span> Setup</h2>
<p>We define the data and set initial parameters for the model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load necessary libraries</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(plyr)  <span class="co"># for displaying progress</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(psych) <span class="co"># for plotting</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'psych'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:astsa':

    scatter.hist</code></pre>
</div>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set tolerance and bootstrap parameters</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="co"># tol &lt;- sqrt(.Machine$double.eps)</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a><span class="co"># nboot &lt;- 500</span></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>tol <span class="ot">&lt;-</span> <span class="fl">0.001</span></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>nboot <span class="ot">&lt;-</span> <span class="dv">200</span></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Define data windows for inflation and interest rate</span></span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">window</span>(qinfl, <span class="fu">c</span>(<span class="dv">1953</span>, <span class="dv">1</span>), <span class="fu">c</span>(<span class="dv">1965</span>, <span class="dv">2</span>))  <span class="co"># Inflation</span></span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>z <span class="ot">&lt;-</span> <span class="fu">window</span>(qintr, <span class="fu">c</span>(<span class="dv">1953</span>, <span class="dv">1</span>), <span class="fu">c</span>(<span class="dv">1965</span>, <span class="dv">2</span>))  <span class="co"># Interest rate</span></span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Set up the observation matrix</span></span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a>num <span class="ot">&lt;-</span> <span class="fu">length</span>(y)</span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a>A <span class="ot">&lt;-</span> <span class="fu">array</span>(z, <span class="at">dim =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, num))</span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a>input <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">1</span>, num, <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="likelihood-function-1" class="level2" data-number="13.3">
<h2 data-number="13.3" class="anchored" data-anchor-id="likelihood-function-1"><span class="header-section-number">13.3</span> Likelihood Function</h2>
<p>The <code>Linn</code> function calculates the likelihood for given parameters using the Kalman filter.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to Calculate Likelihood</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>Linn <span class="ot">&lt;-</span> <span class="cf">function</span>(para, y.data) {</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>  phi <span class="ot">&lt;-</span> para[<span class="dv">1</span>]</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>  alpha <span class="ot">&lt;-</span> para[<span class="dv">2</span>]</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>  b <span class="ot">&lt;-</span> para[<span class="dv">3</span>]</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>  Ups <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">-</span> phi) <span class="sc">*</span> b</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>  cQ <span class="ot">&lt;-</span> para[<span class="dv">4</span>]</span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>  cR <span class="ot">&lt;-</span> para[<span class="dv">5</span>]</span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>  kf <span class="ot">&lt;-</span> <span class="fu">xKfilter2</span>(num, y.data, A, mu0, Sigma0, phi, Ups, alpha, <span class="dv">1</span>, cQ, cR, <span class="dv">0</span>, input)</span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(kf<span class="sc">$</span>like)</span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="parameter-estimation-3" class="level2" data-number="13.4">
<h2 data-number="13.4" class="anchored" data-anchor-id="parameter-estimation-3"><span class="header-section-number">13.4</span> Parameter Estimation</h2>
<p>We use the <code>optim</code> function to estimate the parameters by maximizing the likelihood.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Initial values for parameters</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>mu0 <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>Sigma0 <span class="ot">&lt;-</span> <span class="fl">0.01</span></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>init.par <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">phi =</span> <span class="fl">0.84</span>, <span class="at">alpha =</span> <span class="sc">-</span><span class="fl">0.77</span>, <span class="at">b =</span> <span class="fl">0.85</span>, <span class="at">cQ =</span> <span class="fl">0.12</span>, <span class="at">cR =</span> <span class="fl">1.1</span>)</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate parameters</span></span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>est <span class="ot">&lt;-</span> <span class="fu">optim</span>(init.par, Linn, <span class="cn">NULL</span>, <span class="at">y.data =</span> y, <span class="at">method =</span> <span class="st">"BFGS"</span>, <span class="at">hessian =</span> <span class="cn">TRUE</span>,</span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>             <span class="at">control =</span> <span class="fu">list</span>(<span class="at">trace =</span> <span class="dv">1</span>, <span class="at">REPORT =</span> <span class="dv">1</span>, <span class="at">reltol =</span> tol))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>initial  value 35.774060 
iter   1 value 35.742590
final  value 35.742590 
converged</code></pre>
</div>
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>SE <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">diag</span>(<span class="fu">solve</span>(est<span class="sc">$</span>hessian)))</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(<span class="fu">cbind</span>(<span class="at">estimate =</span> est<span class="sc">$</span>par, SE), <span class="dv">3</span>)  <span class="co"># Display estimates and standard errors</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      estimate    SE
phi      0.843 0.224
alpha   -0.770 0.489
b        0.847 0.230
cQ       0.127 0.104
cR       1.103 0.142</code></pre>
</div>
</div>
</section>
<section id="bootstrap-procedure" class="level2" data-number="13.5">
<h2 data-number="13.5" class="anchored" data-anchor-id="bootstrap-procedure"><span class="header-section-number">13.5</span> Bootstrap Procedure</h2>
<p>The bootstrap procedure is used to assess the variability of parameter estimates. The first three observations are fixed, and new residuals are sampled for each bootstrap iteration.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Run the filter at the estimates</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>kf <span class="ot">&lt;-</span> <span class="fu">xKfilter2</span>(num, y, A, mu0, Sigma0, est<span class="sc">$</span>par[<span class="dv">1</span>], (<span class="dv">1</span> <span class="sc">-</span> est<span class="sc">$</span>par[<span class="dv">1</span>]) <span class="sc">*</span> est<span class="sc">$</span>par[<span class="dv">3</span>], </span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>               est<span class="sc">$</span>par[<span class="dv">2</span>], <span class="dv">1</span>, est<span class="sc">$</span>par[<span class="dv">4</span>], est<span class="sc">$</span>par[<span class="dv">5</span>], <span class="dv">0</span>, input)</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize necessary values for bootstrap</span></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>xp <span class="ot">&lt;-</span> kf<span class="sc">$</span>xp</span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>innov <span class="ot">&lt;-</span> kf<span class="sc">$</span>innov</span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>sig <span class="ot">&lt;-</span> kf<span class="sc">$</span>sig</span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>K <span class="ot">&lt;-</span> kf<span class="sc">$</span>K</span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>e <span class="ot">&lt;-</span> innov <span class="sc">/</span> <span class="fu">sqrt</span>(sig)</span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a>e.star <span class="ot">&lt;-</span> e</span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a>y.star <span class="ot">&lt;-</span> y</span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a>xp.star <span class="ot">&lt;-</span> xp</span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true" tabindex="-1"></a>k <span class="ot">&lt;-</span> <span class="dv">4</span><span class="sc">:</span><span class="dv">50</span>  <span class="co"># Hold first 3 observations fixed</span></span>
<span id="cb64-15"><a href="#cb64-15" aria-hidden="true" tabindex="-1"></a>para.star <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, nboot, <span class="dv">5</span>)</span>
<span id="cb64-16"><a href="#cb64-16" aria-hidden="true" tabindex="-1"></a>init.par <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.84</span>, <span class="sc">-</span><span class="fl">0.77</span>, <span class="fl">0.85</span>, <span class="fl">0.12</span>, <span class="fl">1.1</span>)</span>
<span id="cb64-17"><a href="#cb64-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-18"><a href="#cb64-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize progress display</span></span>
<span id="cb64-19"><a href="#cb64-19" aria-hidden="true" tabindex="-1"></a>pr <span class="ot">&lt;-</span> <span class="fu">progress_text</span>()</span>
<span id="cb64-20"><a href="#cb64-20" aria-hidden="true" tabindex="-1"></a>pr<span class="sc">$</span><span class="fu">init</span>(nboot)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
  |                                                                            
  |                                                                      |   0%</code></pre>
</div>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nboot) {</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>  pr<span class="sc">$</span><span class="fu">step</span>()</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>  e.star[k] <span class="ot">&lt;-</span> <span class="fu">sample</span>(e[k], <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (j <span class="cf">in</span> k) {</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>    xp.star[j] <span class="ot">&lt;-</span> est<span class="sc">$</span>par[<span class="dv">1</span>] <span class="sc">*</span> xp.star[j <span class="sc">-</span> <span class="dv">1</span>] <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">-</span> est<span class="sc">$</span>par[<span class="dv">1</span>]) <span class="sc">*</span> est<span class="sc">$</span>par[<span class="dv">3</span>] <span class="sc">+</span> </span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>                  K[j] <span class="sc">*</span> <span class="fu">sqrt</span>(sig[j]) <span class="sc">*</span> e.star[j]</span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a>  y.star[k] <span class="ot">&lt;-</span> z[k] <span class="sc">*</span> xp.star[k] <span class="sc">+</span> est<span class="sc">$</span>par[<span class="dv">2</span>] <span class="sc">+</span> <span class="fu">sqrt</span>(sig[k]) <span class="sc">*</span> e.star[j]</span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a>  est.star <span class="ot">&lt;-</span> <span class="fu">optim</span>(init.par, Linn, <span class="cn">NULL</span>, <span class="at">y.data =</span> y.star, <span class="at">method =</span> <span class="st">"BFGS"</span>,</span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a>                    <span class="at">control =</span> <span class="fu">list</span>(<span class="at">reltol =</span> tol))</span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true" tabindex="-1"></a>  para.star[i, ] <span class="ot">&lt;-</span> <span class="fu">c</span>(est.star<span class="sc">$</span>par[<span class="dv">1</span>], est.star<span class="sc">$</span>par[<span class="dv">2</span>], est.star<span class="sc">$</span>par[<span class="dv">3</span>],</span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">abs</span>(est.star<span class="sc">$</span>par[<span class="dv">4</span>]), <span class="fu">abs</span>(est.star<span class="sc">$</span>par[<span class="dv">5</span>]))</span>
<span id="cb66-16"><a href="#cb66-16" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
  |                                                                            
  |=                                                                     |   1%
  |                                                                            
  |=                                                                     |   2%
  |                                                                            
  |==                                                                    |   2%
  |                                                                            
  |==                                                                    |   3%
  |                                                                            
  |==                                                                    |   4%
  |                                                                            
  |===                                                                   |   4%
  |                                                                            
  |====                                                                  |   5%
  |                                                                            
  |====                                                                  |   6%
  |                                                                            
  |=====                                                                 |   6%
  |                                                                            
  |=====                                                                 |   7%
  |                                                                            
  |=====                                                                 |   8%
  |                                                                            
  |======                                                                |   8%
  |                                                                            
  |======                                                                |   9%
  |                                                                            
  |=======                                                               |  10%
  |                                                                            
  |========                                                              |  11%
  |                                                                            
  |========                                                              |  12%
  |                                                                            
  |=========                                                             |  12%
  |                                                                            
  |=========                                                             |  13%
  |                                                                            
  |=========                                                             |  14%
  |                                                                            
  |==========                                                            |  14%
  |                                                                            
  |==========                                                            |  15%
  |                                                                            
  |===========                                                           |  16%
  |                                                                            
  |============                                                          |  16%
  |                                                                            
  |============                                                          |  17%
  |                                                                            
  |============                                                          |  18%
  |                                                                            
  |=============                                                         |  18%
  |                                                                            
  |=============                                                         |  19%
  |                                                                            
  |==============                                                        |  20%
  |                                                                            
  |===============                                                       |  21%
  |                                                                            
  |===============                                                       |  22%
  |                                                                            
  |================                                                      |  22%
  |                                                                            
  |================                                                      |  23%
  |                                                                            
  |================                                                      |  24%
  |                                                                            
  |=================                                                     |  24%
  |                                                                            
  |==================                                                    |  25%
  |                                                                            
  |==================                                                    |  26%
  |                                                                            
  |===================                                                   |  26%
  |                                                                            
  |===================                                                   |  27%
  |                                                                            
  |===================                                                   |  28%
  |                                                                            
  |====================                                                  |  28%
  |                                                                            
  |====================                                                  |  29%
  |                                                                            
  |=====================                                                 |  30%
  |                                                                            
  |======================                                                |  31%
  |                                                                            
  |======================                                                |  32%
  |                                                                            
  |=======================                                               |  32%
  |                                                                            
  |=======================                                               |  33%
  |                                                                            
  |=======================                                               |  34%
  |                                                                            
  |========================                                              |  34%
  |                                                                            
  |========================                                              |  35%
  |                                                                            
  |=========================                                             |  36%
  |                                                                            
  |==========================                                            |  36%
  |                                                                            
  |==========================                                            |  37%
  |                                                                            
  |==========================                                            |  38%
  |                                                                            
  |===========================                                           |  38%
  |                                                                            
  |===========================                                           |  39%
  |                                                                            
  |============================                                          |  40%
  |                                                                            
  |=============================                                         |  41%
  |                                                                            
  |=============================                                         |  42%
  |                                                                            
  |==============================                                        |  42%
  |                                                                            
  |==============================                                        |  43%
  |                                                                            
  |==============================                                        |  44%
  |                                                                            
  |===============================                                       |  44%
  |                                                                            
  |================================                                      |  45%
  |                                                                            
  |================================                                      |  46%
  |                                                                            
  |=================================                                     |  46%
  |                                                                            
  |=================================                                     |  47%
  |                                                                            
  |=================================                                     |  48%
  |                                                                            
  |==================================                                    |  48%
  |                                                                            
  |==================================                                    |  49%
  |                                                                            
  |===================================                                   |  50%
  |                                                                            
  |====================================                                  |  51%
  |                                                                            
  |====================================                                  |  52%
  |                                                                            
  |=====================================                                 |  52%
  |                                                                            
  |=====================================                                 |  53%
  |                                                                            
  |=====================================                                 |  54%
  |                                                                            
  |======================================                                |  54%
  |                                                                            
  |======================================                                |  55%
  |                                                                            
  |=======================================                               |  56%
  |                                                                            
  |========================================                              |  56%
  |                                                                            
  |========================================                              |  57%
  |                                                                            
  |========================================                              |  58%
  |                                                                            
  |=========================================                             |  58%
  |                                                                            
  |=========================================                             |  59%
  |                                                                            
  |==========================================                            |  60%
  |                                                                            
  |===========================================                           |  61%
  |                                                                            
  |===========================================                           |  62%
  |                                                                            
  |============================================                          |  62%
  |                                                                            
  |============================================                          |  63%
  |                                                                            
  |============================================                          |  64%
  |                                                                            
  |=============================================                         |  64%
  |                                                                            
  |==============================================                        |  65%
  |                                                                            
  |==============================================                        |  66%
  |                                                                            
  |===============================================                       |  66%
  |                                                                            
  |===============================================                       |  67%
  |                                                                            
  |===============================================                       |  68%
  |                                                                            
  |================================================                      |  68%
  |                                                                            
  |================================================                      |  69%
  |                                                                            
  |=================================================                     |  70%
  |                                                                            
  |==================================================                    |  71%
  |                                                                            
  |==================================================                    |  72%
  |                                                                            
  |===================================================                   |  72%
  |                                                                            
  |===================================================                   |  73%
  |                                                                            
  |===================================================                   |  74%
  |                                                                            
  |====================================================                  |  74%
  |                                                                            
  |====================================================                  |  75%
  |                                                                            
  |=====================================================                 |  76%
  |                                                                            
  |======================================================                |  76%
  |                                                                            
  |======================================================                |  77%
  |                                                                            
  |======================================================                |  78%
  |                                                                            
  |=======================================================               |  78%
  |                                                                            
  |=======================================================               |  79%
  |                                                                            
  |========================================================              |  80%
  |                                                                            
  |=========================================================             |  81%
  |                                                                            
  |=========================================================             |  82%
  |                                                                            
  |==========================================================            |  82%
  |                                                                            
  |==========================================================            |  83%
  |                                                                            
  |==========================================================            |  84%
  |                                                                            
  |===========================================================           |  84%
  |                                                                            
  |============================================================          |  85%
  |                                                                            
  |============================================================          |  86%
  |                                                                            
  |=============================================================         |  86%
  |                                                                            
  |=============================================================         |  87%
  |                                                                            
  |=============================================================         |  88%
  |                                                                            
  |==============================================================        |  88%
  |                                                                            
  |==============================================================        |  89%
  |                                                                            
  |===============================================================       |  90%
  |                                                                            
  |================================================================      |  91%
  |                                                                            
  |================================================================      |  92%
  |                                                                            
  |=================================================================     |  92%
  |                                                                            
  |=================================================================     |  93%
  |                                                                            
  |=================================================================     |  94%
  |                                                                            
  |==================================================================    |  94%
  |                                                                            
  |==================================================================    |  95%
  |                                                                            
  |===================================================================   |  96%
  |                                                                            
  |====================================================================  |  96%
  |                                                                            
  |====================================================================  |  97%
  |                                                                            
  |====================================================================  |  98%
  |                                                                            
  |===================================================================== |  98%
  |                                                                            
  |===================================================================== |  99%
  |                                                                            
  |======================================================================| 100%</code></pre>
</div>
</div>
</section>
<section id="standard-error-calculation-from-bootstrap" class="level2" data-number="13.6">
<h2 data-number="13.6" class="anchored" data-anchor-id="standard-error-calculation-from-bootstrap"><span class="header-section-number">13.6</span> Standard Error Calculation from Bootstrap</h2>
<p>Standard errors are calculated from the bootstrap replicates.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate RMSE for bootstrap estimates</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>rmse <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="dv">5</span>)</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>) {</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>  rmse[i] <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">sum</span>((para.star[, i] <span class="sc">-</span> est<span class="sc">$</span>par[i])<span class="sc">^</span><span class="dv">2</span>) <span class="sc">/</span> nboot)</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(i, rmse[i], <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1 0.2427027 
2 0.8895267 
3 0.6339146 
4 0.08817372 
5 0.8628564 </code></pre>
</div>
</div>
</section>
<section id="scatter-plot-of-bootstrap-estimates" class="level2" data-number="13.7">
<h2 data-number="13.7" class="anchored" data-anchor-id="scatter-plot-of-bootstrap-estimates"><span class="header-section-number">13.7</span> Scatter Plot of Bootstrap Estimates</h2>
<p>The <code>scatter.hist</code> function from the <code>psych</code> package is used to visualize the distribution of the parameter estimates.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot phi and sigw</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>phi <span class="ot">&lt;-</span> para.star[, <span class="dv">1</span>]</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>sigw <span class="ot">&lt;-</span> <span class="fu">abs</span>(para.star[, <span class="dv">4</span>])</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>phi <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(phi <span class="sc">&lt;</span> <span class="dv">0</span>, <span class="cn">NA</span>, phi)  <span class="co"># Remove negative phi values for plotting</span></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Scatter plot with histogram</span></span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot phi and sigw without "panel.first" argument</span></span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot phi and sigw without "col" argument</span></span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a><span class="co"># (See a better plot in figure 6.10 in the book)</span></span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a><span class="co"># scatter.hist(sigw, phi, </span></span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a><span class="co">#              ylab = expression(phi), </span></span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a><span class="co">#              xlab = expression(sigma[~w]),</span></span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true" tabindex="-1"></a><span class="co">#              smooth = FALSE, </span></span>
<span id="cb70-15"><a href="#cb70-15" aria-hidden="true" tabindex="-1"></a><span class="co">#              correl = FALSE, </span></span>
<span id="cb70-16"><a href="#cb70-16" aria-hidden="true" tabindex="-1"></a><span class="co">#              density = FALSE, </span></span>
<span id="cb70-17"><a href="#cb70-17" aria-hidden="true" tabindex="-1"></a><span class="co">#              ellipse = FALSE,</span></span>
<span id="cb70-18"><a href="#cb70-18" aria-hidden="true" tabindex="-1"></a><span class="co">#              title = '', </span></span>
<span id="cb70-19"><a href="#cb70-19" aria-hidden="true" tabindex="-1"></a><span class="co">#              pch = 19, </span></span>
<span id="cb70-20"><a href="#cb70-20" aria-hidden="true" tabindex="-1"></a><span class="co">#              cex.lab = 1.2)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="hidden-markov-model-for-earthquake-counts-using-depmixs4" class="level1" data-number="14">
<h1 data-number="14"><span class="header-section-number">14</span> Hidden Markov Model for Earthquake Counts Using depmixS4</h1>
<section id="introduction-7" class="level2" data-number="14.1">
<h2 data-number="14.1" class="anchored" data-anchor-id="introduction-7"><span class="header-section-number">14.1</span> Introduction</h2>
<p>This analysis uses a hidden Markov model (HMM) to model earthquake counts (<code>EQcount</code>) with two states. The model assumes Poisson-distributed earthquake counts in each state, and we estimate the transition probabilities and Poisson rate parameters.</p>
</section>
<section id="model-setup-and-estimation" class="level2" data-number="14.2">
<h2 data-number="14.2" class="anchored" data-anchor-id="model-setup-and-estimation"><span class="header-section-number">14.2</span> Model Setup and Estimation</h2>
<p>We fit a 2-state HMM to the <code>EQcount</code> data, using a Poisson distribution for the emission probabilities. The estimated parameters are extracted and adjusted to ensure state 1 has the smaller lambda (intensity parameter).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load necessary package</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(depmixS4)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: nnet</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: MASS</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: Rsolnp</code></pre>
</div>
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define and fit the model</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">depmix</span>(EQcount <span class="sc">~</span> <span class="dv">1</span>, <span class="at">nstates =</span> <span class="dv">2</span>, <span class="at">data =</span> <span class="fu">data.frame</span>(EQcount), <span class="at">family =</span> <span class="fu">poisson</span>())</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">90210</span>)</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fm <span class="ot">&lt;-</span> <span class="fu">fit</span>(model))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>converged at iteration 26 with logLik: -341.8787 
Initial state probabilities model 
pr1 pr2 
  1   0 

Transition matrix 
        toS1  toS2
fromS1 0.928 0.072
fromS2 0.119 0.881

Response parameters 
Resp 1 : poisson 
    Re1.(Intercept)
St1           2.736
St2           3.259</code></pre>
</div>
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get parameters and ensure state 1 has smaller lambda</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>u <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(<span class="fu">getpars</span>(fm))</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (u[<span class="dv">7</span>] <span class="sc">&lt;=</span> u[<span class="dv">8</span>]) {</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>  para.mle <span class="ot">&lt;-</span> <span class="fu">c</span>(u[<span class="dv">3</span><span class="sc">:</span><span class="dv">6</span>], <span class="fu">exp</span>(u[<span class="dv">7</span>]), <span class="fu">exp</span>(u[<span class="dv">8</span>]))</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>  para.mle <span class="ot">&lt;-</span> <span class="fu">c</span>(u[<span class="dv">6</span><span class="sc">:</span><span class="dv">3</span>], <span class="fu">exp</span>(u[<span class="dv">8</span>]), <span class="fu">exp</span>(u[<span class="dv">7</span>]))</span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Transition matrix and lambda values</span></span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a>mtrans <span class="ot">&lt;-</span> <span class="fu">matrix</span>(para.mle[<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>], <span class="at">byrow =</span> <span class="cn">TRUE</span>, <span class="at">nrow =</span> <span class="dv">2</span>)</span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true" tabindex="-1"></a>lams <span class="ot">&lt;-</span> para.mle[<span class="dv">5</span><span class="sc">:</span><span class="dv">6</span>]</span>
<span id="cb77-12"><a href="#cb77-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-13"><a href="#cb77-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate stationary probabilities</span></span>
<span id="cb77-14"><a href="#cb77-14" aria-hidden="true" tabindex="-1"></a>pi1 <span class="ot">&lt;-</span> mtrans[<span class="dv">2</span>, <span class="dv">1</span>] <span class="sc">/</span> (<span class="dv">2</span> <span class="sc">-</span> mtrans[<span class="dv">1</span>, <span class="dv">1</span>] <span class="sc">-</span> mtrans[<span class="dv">2</span>, <span class="dv">2</span>])</span>
<span id="cb77-15"><a href="#cb77-15" aria-hidden="true" tabindex="-1"></a>pi2 <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> pi1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="visualization-1" class="level2" data-number="14.3">
<h2 data-number="14.3" class="anchored" data-anchor-id="visualization-1"><span class="header-section-number">14.3</span> Visualization</h2>
<p>We visualize the earthquake counts, the posterior probabilities of being in state 2, and the histogram with fitted Poisson distributions.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Setup layout for plots</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a><span class="fu">layout</span>(<span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">3</span>), <span class="dv">2</span>))</span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">1</span>, <span class="dv">1</span>), <span class="at">mgp =</span> <span class="fu">c</span>(<span class="fl">1.6</span>, .<span class="dv">6</span>, <span class="dv">0</span>))</span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot EQcount and states</span></span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(EQcount, <span class="at">main =</span> <span class="st">""</span>, <span class="at">ylab =</span> <span class="st">'EQcount'</span>, <span class="at">type =</span> <span class="st">'h'</span>, <span class="at">col =</span> <span class="fu">gray</span>(<span class="fl">0.7</span>))</span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(EQcount, <span class="at">col =</span> <span class="dv">6</span> <span class="sc">*</span> <span class="fu">posterior</span>(fm)[, <span class="dv">1</span>] <span class="sc">-</span> <span class="dv">2</span>, <span class="at">labels =</span> <span class="fu">posterior</span>(fm)[, <span class="dv">1</span>], <span class="at">cex =</span> <span class="fl">0.9</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in .local(object, ...): Argument 'type' not specified and will default
to 'viterbi'. This default may change in future releases of depmixS4. Please
see ?posterior for alternative options.

Warning in .local(object, ...): Argument 'type' not specified and will default
to 'viterbi'. This default may change in future releases of depmixS4. Please
see ?posterior for alternative options.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot probability of state 2</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">ts</span>(<span class="fu">posterior</span>(fm)[, <span class="dv">3</span>], <span class="at">start =</span> <span class="dv">1900</span>), <span class="at">ylab =</span> <span class="fu">expression</span>(<span class="fu">hat</span>(pi)[<span class="sc">~</span><span class="dv">2</span>]<span class="sc">*</span><span class="st">'(t|n)'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in .local(object, ...): Argument 'type' not specified and will default
to 'viterbi'. This default may change in future releases of depmixS4. Please
see ?posterior for alternative options.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h =</span> <span class="fl">0.5</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Histogram of EQcount with fitted Poisson distributions</span></span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(EQcount, <span class="at">breaks =</span> <span class="dv">30</span>, <span class="at">prob =</span> <span class="cn">TRUE</span>, <span class="at">main =</span> <span class="st">""</span>)</span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>xvals <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">45</span>)</span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>u1 <span class="ot">&lt;-</span> pi1 <span class="sc">*</span> <span class="fu">dpois</span>(xvals, lams[<span class="dv">1</span>])</span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a>u2 <span class="ot">&lt;-</span> pi2 <span class="sc">*</span> <span class="fu">dpois</span>(xvals, lams[<span class="dv">2</span>])</span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(xvals, u1, <span class="at">col =</span> <span class="dv">4</span>)</span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(xvals, u2, <span class="at">col =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="cap6_files/figure-html/unnamed-chunk-40-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="bootstrap-procedure-1" class="level2" data-number="14.4">
<h2 data-number="14.4" class="anchored" data-anchor-id="bootstrap-procedure-1"><span class="header-section-number">14.4</span> Bootstrap Procedure</h2>
<p>A bootstrap procedure is used to estimate the standard errors of the parameters by resampling the residuals. We generate bootstrap samples, fit the model to each sample, and store the estimates.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to generate data from Poisson HMM</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>pois.HMM.generate_sample <span class="ot">&lt;-</span> <span class="cf">function</span>(n, m, lambda, Mtrans, <span class="at">StatDist =</span> <span class="cn">NULL</span>) {</span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(StatDist)) StatDist <span class="ot">&lt;-</span> <span class="fu">solve</span>(<span class="fu">t</span>(<span class="fu">diag</span>(m) <span class="sc">-</span> Mtrans <span class="sc">+</span> <span class="dv">1</span>), <span class="fu">rep</span>(<span class="dv">1</span>, m))</span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>  mvect <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span>m</span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>  state <span class="ot">&lt;-</span> <span class="fu">numeric</span>(n)</span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a>  state[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">sample</span>(mvect, <span class="dv">1</span>, <span class="at">prob =</span> StatDist)</span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>n) state[i] <span class="ot">&lt;-</span> <span class="fu">sample</span>(mvect, <span class="dv">1</span>, <span class="at">prob =</span> Mtrans[state[i <span class="sc">-</span> <span class="dv">1</span>], ])</span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">rpois</span>(n, <span class="at">lambda =</span> lambda[state])</span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">y =</span> y, <span class="at">state =</span> state)</span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb83-11"><a href="#cb83-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-12"><a href="#cb83-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Run bootstrap</span></span>
<span id="cb83-13"><a href="#cb83-13" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">10101101</span>)</span>
<span id="cb83-14"><a href="#cb83-14" aria-hidden="true" tabindex="-1"></a>nboot <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb83-15"><a href="#cb83-15" aria-hidden="true" tabindex="-1"></a>nobs <span class="ot">&lt;-</span> <span class="fu">length</span>(EQcount)</span>
<span id="cb83-16"><a href="#cb83-16" aria-hidden="true" tabindex="-1"></a>para.star <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> nboot, <span class="at">ncol =</span> <span class="dv">6</span>)</span>
<span id="cb83-17"><a href="#cb83-17" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nboot) {</span>
<span id="cb83-18"><a href="#cb83-18" aria-hidden="true" tabindex="-1"></a>  x.star <span class="ot">&lt;-</span> <span class="fu">pois.HMM.generate_sample</span>(<span class="at">n =</span> nobs, <span class="at">m =</span> <span class="dv">2</span>, <span class="at">lambda =</span> lams, <span class="at">Mtrans =</span> mtrans)<span class="sc">$</span>y</span>
<span id="cb83-19"><a href="#cb83-19" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">depmix</span>(x.star <span class="sc">~</span> <span class="dv">1</span>, <span class="at">nstates =</span> <span class="dv">2</span>, <span class="at">data =</span> <span class="fu">data.frame</span>(x.star), <span class="at">family =</span> <span class="fu">poisson</span>())</span>
<span id="cb83-20"><a href="#cb83-20" aria-hidden="true" tabindex="-1"></a>  u <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(<span class="fu">getpars</span>(<span class="fu">fit</span>(model, <span class="at">verbose =</span> <span class="dv">0</span>)))</span>
<span id="cb83-21"><a href="#cb83-21" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (u[<span class="dv">7</span>] <span class="sc">&lt;=</span> u[<span class="dv">8</span>]) {</span>
<span id="cb83-22"><a href="#cb83-22" aria-hidden="true" tabindex="-1"></a>    para.star[j, ] <span class="ot">&lt;-</span> <span class="fu">c</span>(u[<span class="dv">3</span><span class="sc">:</span><span class="dv">6</span>], <span class="fu">exp</span>(u[<span class="dv">7</span>]), <span class="fu">exp</span>(u[<span class="dv">8</span>]))</span>
<span id="cb83-23"><a href="#cb83-23" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb83-24"><a href="#cb83-24" aria-hidden="true" tabindex="-1"></a>    para.star[j, ] <span class="ot">&lt;-</span> <span class="fu">c</span>(u[<span class="dv">6</span><span class="sc">:</span><span class="dv">3</span>], <span class="fu">exp</span>(u[<span class="dv">8</span>]), <span class="fu">exp</span>(u[<span class="dv">7</span>]))</span>
<span id="cb83-25"><a href="#cb83-25" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb83-26"><a href="#cb83-26" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>converged at iteration 28 with logLik: -317.3536 
converged at iteration 10 with logLik: -336.3123 
converged at iteration 15 with logLik: -330.7023 
converged at iteration 16 with logLik: -325.2017 
converged at iteration 19 with logLik: -334.0389 
converged at iteration 16 with logLik: -321.5097 
converged at iteration 25 with logLik: -342.4645 
converged at iteration 15 with logLik: -323.6899 
converged at iteration 9 with logLik: -321.6437 
converged at iteration 18 with logLik: -322.362 
converged at iteration 12 with logLik: -327.4347 
converged at iteration 10 with logLik: -317.0057 
converged at iteration 9 with logLik: -338.8998 
converged at iteration 12 with logLik: -334.3831 
converged at iteration 10 with logLik: -320.6662 
converged at iteration 15 with logLik: -337.1912 
converged at iteration 14 with logLik: -329.5808 
converged at iteration 17 with logLik: -323.376 
converged at iteration 15 with logLik: -327.2818 
converged at iteration 15 with logLik: -324.8806 
converged at iteration 12 with logLik: -328.8237 
converged at iteration 13 with logLik: -323.2429 
converged at iteration 35 with logLik: -303.1696 
converged at iteration 14 with logLik: -311.838 
converged at iteration 20 with logLik: -325.593 
converged at iteration 25 with logLik: -344.3057 
converged at iteration 13 with logLik: -336.7609 
converged at iteration 9 with logLik: -331.3855 
converged at iteration 16 with logLik: -329.6708 
converged at iteration 38 with logLik: -320.4871 
converged at iteration 40 with logLik: -321.4419 
converged at iteration 20 with logLik: -340.2987 
converged at iteration 11 with logLik: -316.1531 
converged at iteration 19 with logLik: -331.9695 
converged at iteration 15 with logLik: -328.3009 
converged at iteration 22 with logLik: -336.7947 
converged at iteration 14 with logLik: -335.777 
converged at iteration 19 with logLik: -336.8923 
converged at iteration 17 with logLik: -328.7383 
converged at iteration 14 with logLik: -338.4921 
converged at iteration 18 with logLik: -335.8289 
converged at iteration 13 with logLik: -324.3853 
converged at iteration 19 with logLik: -332.4478 
converged at iteration 23 with logLik: -331.5049 
converged at iteration 18 with logLik: -320.7098 
converged at iteration 16 with logLik: -333.7366 
converged at iteration 16 with logLik: -342.2729 
converged at iteration 13 with logLik: -330.8512 
converged at iteration 9 with logLik: -323.9359 
converged at iteration 17 with logLik: -332.7441 
converged at iteration 24 with logLik: -322.1631 
converged at iteration 54 with logLik: -324.2249 
converged at iteration 17 with logLik: -312.7729 
converged at iteration 13 with logLik: -331.0078 
converged at iteration 16 with logLik: -320.4881 
converged at iteration 12 with logLik: -333.6678 
converged at iteration 17 with logLik: -351.9982 
converged at iteration 16 with logLik: -312.2302 
converged at iteration 9 with logLik: -324.7744 
converged at iteration 11 with logLik: -328.7093 
converged at iteration 12 with logLik: -326.4755 
converged at iteration 17 with logLik: -331.4812 
converged at iteration 13 with logLik: -335.3246 
converged at iteration 14 with logLik: -320.2642 
converged at iteration 11 with logLik: -321.1371 
converged at iteration 22 with logLik: -343.5264 
converged at iteration 15 with logLik: -344.8566 
converged at iteration 12 with logLik: -324.5623 
converged at iteration 13 with logLik: -329.2879 
converged at iteration 29 with logLik: -343.0569 
converged at iteration 17 with logLik: -336.5592 
converged at iteration 20 with logLik: -333.9896 
converged at iteration 18 with logLik: -341.6623 
converged at iteration 10 with logLik: -319.5575 
converged at iteration 10 with logLik: -320.8678 
converged at iteration 17 with logLik: -335.7764 
converged at iteration 16 with logLik: -324.6303 
converged at iteration 13 with logLik: -343.359 
converged at iteration 14 with logLik: -335.697 
converged at iteration 167 with logLik: -321.9255 
converged at iteration 49 with logLik: -309.581 
converged at iteration 64 with logLik: -337.8977 
converged at iteration 19 with logLik: -333.5856 
converged at iteration 26 with logLik: -329.8142 
converged at iteration 11 with logLik: -333.4356 
converged at iteration 40 with logLik: -335.0244 
converged at iteration 15 with logLik: -321.1205 
converged at iteration 35 with logLik: -326.9086 
converged at iteration 18 with logLik: -323.0662 
converged at iteration 18 with logLik: -330.1606 
converged at iteration 15 with logLik: -320.2706 
converged at iteration 19 with logLik: -323.3005 
converged at iteration 15 with logLik: -320.9108 
converged at iteration 13 with logLik: -326.7983 
converged at iteration 12 with logLik: -317.1947 
converged at iteration 14 with logLik: -333.5056 
converged at iteration 13 with logLik: -329.1758 
converged at iteration 9 with logLik: -319.8779 
converged at iteration 13 with logLik: -341.9616 
converged at iteration 12 with logLik: -321.6762 </code></pre>
</div>
</div>
</section>
<section id="bootstrapped-standard-errors" class="level2" data-number="14.5">
<h2 data-number="14.5" class="anchored" data-anchor-id="bootstrapped-standard-errors"><span class="header-section-number">14.5</span> Bootstrapped Standard Errors</h2>
<p>Calculate the standard errors of the parameters based on the bootstrap replicates.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate bootstrapped standard errors</span></span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>SE <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">apply</span>(para.star, <span class="dv">2</span>, var) <span class="sc">+</span> (<span class="fu">apply</span>(para.star, <span class="dv">2</span>, mean) <span class="sc">-</span> para.mle)<span class="sc">^</span><span class="dv">2</span>)[<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">4</span><span class="sc">:</span><span class="dv">6</span>)]</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(SE) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'seM11/M12'</span>, <span class="st">'seM21/M22'</span>, <span class="st">'seLam1'</span>, <span class="st">'seLam2'</span>)</span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>SE  <span class="co"># Display standard errors</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> seM11/M12  seM21/M22     seLam1     seLam2 
0.04074297 0.09218465 0.66300322 1.10658114 </code></pre>
</div>
</div>
</section>
</section>
<section id="hidden-markov-model-for-sp500-weekly-returns." class="level1" data-number="15">
<h1 data-number="15"><span class="header-section-number">15</span> Hidden Markov Model for S&amp;P500 Weekly Returns.</h1>
<section id="introduction-8" class="level2" data-number="15.1">
<h2 data-number="15.1" class="anchored" data-anchor-id="introduction-8"><span class="header-section-number">15.1</span> Introduction</h2>
<p>This analysis fits a 3-state hidden Markov model (HMM) to the S&amp;P500 weekly returns (<code>sp500w</code>). The HMM assumes that returns follow a Gaussian distribution in each state. The model is estimated using maximum likelihood, and bootstrap is used to assess parameter variability.</p>
</section>
<section id="model-setup-and-estimation-1" class="level2" data-number="15.2">
<h2 data-number="15.2" class="anchored" data-anchor-id="model-setup-and-estimation-1"><span class="header-section-number">15.2</span> Model Setup and Estimation</h2>
<p>We define and fit a 3-state HMM using the <code>depmixS4</code> package.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare the data</span></span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">ts</span>(sp500w, <span class="at">start =</span> <span class="dv">2003</span>, <span class="at">freq =</span> <span class="dv">52</span>)</span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Define and fit the model</span></span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a>mod3 <span class="ot">&lt;-</span> <span class="fu">depmix</span>(y <span class="sc">~</span> <span class="dv">1</span>, <span class="at">nstates =</span> <span class="dv">3</span>, <span class="at">data =</span> <span class="fu">data.frame</span>(y))</span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2</span>)</span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fm3 <span class="ot">&lt;-</span> <span class="fu">fit</span>(mod3))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>converged at iteration 363 with logLik: 1236.996 
Initial state probabilities model 
pr1 pr2 pr3 
  1   0   0 

Transition matrix 
        toS1  toS2  toS3
fromS1 0.942 0.027 0.032
fromS2 0.261 0.000 0.739
fromS3 0.000 0.055 0.945

Response parameters 
Resp 1 : gaussian 
    Re1.(Intercept) Re1.sd
St1          -0.003  0.044
St2          -0.034  0.009
St3           0.004  0.014</code></pre>
</div>
</div>
</section>
<section id="parameter-estimates" class="level2" data-number="15.3">
<h2 data-number="15.3" class="anchored" data-anchor-id="parameter-estimates"><span class="header-section-number">15.3</span> Parameter Estimates</h2>
<p>We extract and adjust the parameter estimates to handle potential label-switching issues.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract maximum likelihood estimates (MLEs)</span></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>para.mle <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(<span class="fu">getpars</span>(fm3)[<span class="sc">-</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>)])</span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>permu <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>), <span class="dv">3</span>, <span class="dv">3</span>)  <span class="co"># Adjust for label-switching</span></span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Transition matrix and Gaussian parameters</span></span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a>mtrans.mle <span class="ot">&lt;-</span> permu <span class="sc">%*%</span> <span class="fu">round</span>(<span class="fu">t</span>(<span class="fu">matrix</span>(para.mle[<span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>], <span class="dv">3</span>, <span class="dv">3</span>)), <span class="dv">3</span>) <span class="sc">%*%</span> permu</span>
<span id="cb89-7"><a href="#cb89-7" aria-hidden="true" tabindex="-1"></a>norms.mle <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">matrix</span>(para.mle[<span class="dv">10</span><span class="sc">:</span><span class="dv">15</span>], <span class="dv">2</span>, <span class="dv">3</span>), <span class="dv">3</span>) <span class="sc">%*%</span> permu</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="visualization-2" class="level2" data-number="15.4">
<h2 data-number="15.4" class="anchored" data-anchor-id="visualization-2"><span class="header-section-number">15.4</span> Visualization</h2>
<p>We visualize the returns and their posterior probabilities, as well as the autocorrelation and histogram with Gaussian fits for each state.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot setup</span></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a><span class="fu">layout</span>(<span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">3</span>), <span class="dv">2</span>), <span class="at">heights =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="fl">0.75</span>))</span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="fl">2.5</span>, <span class="fl">2.5</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span>), <span class="at">mgp =</span> <span class="fu">c</span>(<span class="fl">1.6</span>, <span class="fl">0.6</span>, <span class="dv">0</span>))</span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot returns and posterior probabilities</span></span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(y, <span class="at">main =</span> <span class="st">""</span>, <span class="at">ylab =</span> <span class="st">'S&amp;P500 Weekly Returns'</span>, <span class="at">col =</span> <span class="fu">gray</span>(<span class="fl">0.7</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.11</span>, <span class="fl">0.11</span>))</span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a>culer <span class="ot">&lt;-</span> <span class="dv">4</span> <span class="sc">-</span> <span class="fu">posterior</span>(fm3)[, <span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in .local(object, ...): Argument 'type' not specified and will default
to 'viterbi'. This default may change in future releases of depmixS4. Please
see ?posterior for alternative options.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>culer[culer <span class="sc">==</span> <span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="dv">4</span>  <span class="co"># Switch labels for state 1 and 3</span></span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(y, <span class="at">col =</span> culer, <span class="at">labels =</span> <span class="dv">4</span> <span class="sc">-</span> <span class="fu">posterior</span>(fm3)[, <span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in .local(object, ...): Argument 'type' not specified and will default
to 'viterbi'. This default may change in future releases of depmixS4. Please
see ?posterior for alternative options.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot autocorrelation of squared returns</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a><span class="fu">acf</span>(y<span class="sc">^</span><span class="dv">2</span>, <span class="at">xlim =</span> <span class="fu">c</span>(<span class="fl">0.02</span>, <span class="fl">0.5</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.09</span>, <span class="fl">0.5</span>), <span class="at">panel.first =</span> <span class="fu">grid</span>(<span class="at">lty =</span> <span class="dv">2</span>))</span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Histogram of returns with Gaussian fits</span></span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(y, <span class="dv">25</span>, <span class="at">prob =</span> <span class="cn">TRUE</span>, <span class="at">main =</span> <span class="st">""</span>)</span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a>culer <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">4</span>)</span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a>pi.hat <span class="ot">&lt;-</span> <span class="fu">colSums</span>(<span class="fu">posterior</span>(fm3)[<span class="sc">-</span><span class="dv">1</span>, <span class="dv">2</span><span class="sc">:</span><span class="dv">4</span>]) <span class="sc">/</span> <span class="fu">length</span>(y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in .local(object, ...): Argument 'type' not specified and will default
to 'viterbi'. This default may change in future releases of depmixS4. Please
see ?posterior for alternative options.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>) {</span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> norms.mle[<span class="dv">1</span>, i]</span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>  sig <span class="ot">&lt;-</span> norms.mle[<span class="dv">2</span>, i]</span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="fl">0.15</span>, <span class="fl">0.12</span>, <span class="at">by =</span> <span class="fl">0.001</span>)</span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(x, pi.hat[<span class="dv">4</span> <span class="sc">-</span> i] <span class="sc">*</span> <span class="fu">dnorm</span>(x, <span class="at">mean =</span> mu, <span class="at">sd =</span> sig), <span class="at">col =</span> culer[i])</span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="cap6_files/figure-html/unnamed-chunk-45-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="bootstrap-procedure-2" class="level2" data-number="15.5">
<h2 data-number="15.5" class="anchored" data-anchor-id="bootstrap-procedure-2"><span class="header-section-number">15.5</span> Bootstrap Procedure</h2>
<p>We use a bootstrap procedure to assess the variability of the parameter estimates by simulating data from the fitted model and re-estimating parameters.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Bootstrap setup</span></span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">666</span>)</span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>n.obs <span class="ot">&lt;-</span> <span class="fu">length</span>(y)</span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a>n.boot <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a>para.star <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> n.boot, <span class="at">ncol =</span> <span class="dv">15</span>)</span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a>respst <span class="ot">&lt;-</span> para.mle[<span class="dv">10</span><span class="sc">:</span><span class="dv">15</span>]</span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a>trst <span class="ot">&lt;-</span> para.mle[<span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>]</span>
<span id="cb97-8"><a href="#cb97-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-9"><a href="#cb97-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Run bootstrap</span></span>
<span id="cb97-10"><a href="#cb97-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (nb <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n.boot) {</span>
<span id="cb97-11"><a href="#cb97-11" aria-hidden="true" tabindex="-1"></a>  mod <span class="ot">&lt;-</span> <span class="fu">simulate</span>(mod3)</span>
<span id="cb97-12"><a href="#cb97-12" aria-hidden="true" tabindex="-1"></a>  y.star <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(mod<span class="sc">@</span>response[[<span class="dv">1</span>]][[<span class="dv">1</span>]]<span class="sc">@</span>y)</span>
<span id="cb97-13"><a href="#cb97-13" aria-hidden="true" tabindex="-1"></a>  dfy <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(y.star)</span>
<span id="cb97-14"><a href="#cb97-14" aria-hidden="true" tabindex="-1"></a>  mod.star <span class="ot">&lt;-</span> <span class="fu">depmix</span>(y.star <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> dfy, <span class="at">respst =</span> respst, <span class="at">trst =</span> trst, <span class="at">nst =</span> <span class="dv">3</span>)</span>
<span id="cb97-15"><a href="#cb97-15" aria-hidden="true" tabindex="-1"></a>  fm.star <span class="ot">&lt;-</span> <span class="fu">fit</span>(mod.star, <span class="at">emcontrol =</span> <span class="fu">em.control</span>(<span class="at">tol =</span> <span class="fl">1e-5</span>), <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span>
<span id="cb97-16"><a href="#cb97-16" aria-hidden="true" tabindex="-1"></a>  para.star[nb, ] <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(<span class="fu">getpars</span>(fm.star)[<span class="sc">-</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>)])</span>
<span id="cb97-17"><a href="#cb97-17" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>converged at iteration 137 with logLik: -685.0962 
converged at iteration 40 with logLik: -715.0901 
converged at iteration 42 with logLik: -711.9793 
converged at iteration 62 with logLik: -728.6847 
converged at iteration 47 with logLik: -683.3955 
converged at iteration 73 with logLik: -719.2561 
converged at iteration 18 with logLik: -719.1667 
converged at iteration 10 with logLik: -717.0603 
converged at iteration 41 with logLik: -713.9096 
converged at iteration 36 with logLik: -714.0937 
converged at iteration 61 with logLik: -711.3154 
converged at iteration 68 with logLik: -689.7452 
converged at iteration 59 with logLik: -718.1053 
converged at iteration 68 with logLik: -715.2818 
converged at iteration 111 with logLik: -725.1249 
converged at iteration 34 with logLik: -707.9774 
converged at iteration 37 with logLik: -722.7253 
converged at iteration 25 with logLik: -721.1461 
converged at iteration 70 with logLik: -687.7122 
converged at iteration 89 with logLik: -703.9078 
converged at iteration 127 with logLik: -712.3814 
converged at iteration 47 with logLik: -709.9084 
converged at iteration 49 with logLik: -719.1742 
converged at iteration 86 with logLik: -716.4459 
converged at iteration 19 with logLik: -728.5627 
converged at iteration 117 with logLik: -741.5508 
converged at iteration 59 with logLik: -724.3466 
converged at iteration 125 with logLik: -709.3661 
converged at iteration 29 with logLik: -702.9124 
converged at iteration 73 with logLik: -723.6699 
converged at iteration 5 with logLik: -707.7749 
converged at iteration 30 with logLik: -706.955 
converged at iteration 68 with logLik: -717.8612 
converged at iteration 53 with logLik: -699.8133 
converged at iteration 63 with logLik: -738.885 
converged at iteration 49 with logLik: -714.506 
converged at iteration 10 with logLik: -720.1578 
converged at iteration 4 with logLik: -745.3851 
converged at iteration 134 with logLik: -736.3881 
converged at iteration 10 with logLik: -722.0937 
converged at iteration 26 with logLik: -716.9009 
converged at iteration 112 with logLik: -719.9439 
converged at iteration 5 with logLik: -736.8251 
converged at iteration 4 with logLik: -737.3519 
converged at iteration 33 with logLik: -717.5958 
converged at iteration 46 with logLik: -689.7854 
converged at iteration 67 with logLik: -718.414 
converged at iteration 203 with logLik: -708.6658 
converged at iteration 21 with logLik: -720.1915 
converged at iteration 55 with logLik: -722.1156 
converged at iteration 129 with logLik: -712.7773 
converged at iteration 7 with logLik: -716.8763 
converged at iteration 6 with logLik: -697.5471 
converged at iteration 26 with logLik: -714.4512 
converged at iteration 82 with logLik: -746.5156 
converged at iteration 13 with logLik: -742.0853 
converged at iteration 30 with logLik: -730.0876 
converged at iteration 85 with logLik: -700.2979 
converged at iteration 63 with logLik: -716.1117 
converged at iteration 18 with logLik: -678.0246 
converged at iteration 142 with logLik: -719.0167 
converged at iteration 88 with logLik: -727.6358 
converged at iteration 13 with logLik: -719.2273 
converged at iteration 55 with logLik: -727.4717 
converged at iteration 29 with logLik: -729.9938 
converged at iteration 41 with logLik: -698.3121 
converged at iteration 18 with logLik: -717.0544 
converged at iteration 45 with logLik: -736.7178 
converged at iteration 86 with logLik: -731.9154 
converged at iteration 50 with logLik: -705.7303 
converged at iteration 20 with logLik: -749.1358 
converged at iteration 75 with logLik: -703.0108 
converged at iteration 39 with logLik: -696.3187 
converged at iteration 21 with logLik: -705.1997 
converged at iteration 79 with logLik: -720.6175 
converged at iteration 47 with logLik: -667.1072 
converged at iteration 91 with logLik: -752.0564 
converged at iteration 99 with logLik: -698.3989 
converged at iteration 3 with logLik: -717.7247 
converged at iteration 64 with logLik: -710.3168 
converged at iteration 144 with logLik: -701.0941 
converged at iteration 49 with logLik: -742.9761 
converged at iteration 74 with logLik: -741.614 
converged at iteration 86 with logLik: -735.7934 
converged at iteration 179 with logLik: -706.4811 
converged at iteration 26 with logLik: -713.8593 
converged at iteration 32 with logLik: -723.8202 
converged at iteration 93 with logLik: -744.5042 
converged at iteration 20 with logLik: -731.8394 
converged at iteration 5 with logLik: -718.826 
converged at iteration 110 with logLik: -726.9593 
converged at iteration 66 with logLik: -726.0535 
converged at iteration 77 with logLik: -724.0721 
converged at iteration 78 with logLik: -702.4992 
converged at iteration 92 with logLik: -703.1677 
converged at iteration 40 with logLik: -709.626 
converged at iteration 89 with logLik: -741.0967 
converged at iteration 140 with logLik: -714.3438 
converged at iteration 186 with logLik: -702.3318 
converged at iteration 42 with logLik: -733.453 </code></pre>
</div>
</div>
</section>
<section id="bootstrap-standard-errors" class="level2" data-number="15.6">
<h2 data-number="15.6" class="anchored" data-anchor-id="bootstrap-standard-errors"><span class="header-section-number">15.6</span> Bootstrap Standard Errors</h2>
<p>We calculate standard errors for the transition probabilities and Gaussian parameters based on the bootstrap replicates.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate bootstrap standard errors</span></span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>SE <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">apply</span>(para.star, <span class="dv">2</span>, var) <span class="sc">+</span> (<span class="fu">apply</span>(para.star, <span class="dv">2</span>, mean) <span class="sc">-</span> para.mle)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Adjust for label-switching</span></span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a>SE.mtrans.mle <span class="ot">&lt;-</span> permu <span class="sc">%*%</span> <span class="fu">round</span>(<span class="fu">t</span>(<span class="fu">matrix</span>(SE[<span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>], <span class="dv">3</span>, <span class="dv">3</span>)), <span class="dv">3</span>) <span class="sc">%*%</span> permu</span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a>SE.norms.mle <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">matrix</span>(SE[<span class="dv">10</span><span class="sc">:</span><span class="dv">15</span>], <span class="dv">2</span>, <span class="dv">3</span>), <span class="dv">3</span>) <span class="sc">%*%</span> permu</span>
<span id="cb99-7"><a href="#cb99-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-8"><a href="#cb99-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Display results</span></span>
<span id="cb99-9"><a href="#cb99-9" aria-hidden="true" tabindex="-1"></a>SE.mtrans.mle</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      [,1]  [,2]  [,3]
[1,] 0.074 0.074 0.000
[2,] 0.275 0.000 0.275
[3,] 0.122 0.057 0.147</code></pre>
</div>
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>SE.norms.mle</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      [,1]  [,2]  [,3]
[1,] 0.173 0.909 0.317
[2,] 0.968 0.777 0.910</code></pre>
</div>
</div>
</section>
</section>
<section id="influenza-regime-switching-model" class="level1" data-number="16">
<h1 data-number="16"><span class="header-section-number">16</span> Influenza Regime-Switching Model</h1>
<section id="introduction-9" class="level2" data-number="16.1">
<h2 data-number="16.1" class="anchored" data-anchor-id="introduction-9"><span class="header-section-number">16.1</span> Introduction</h2>
<p>This analysis models influenza counts (<code>flu</code>) using a regime-switching Kalman filter. The model identifies two regimes: normal and epidemic, with different observation matrices. The parameters are estimated using maximum likelihood, and the results include regime probabilities and predictions.</p>
</section>
<section id="data-setup-and-initialization" class="level2" data-number="16.2">
<h2 data-number="16.2" class="anchored" data-anchor-id="data-setup-and-initialization"><span class="header-section-number">16.2</span> Data Setup and Initialization</h2>
<p>We define the influenza data, number of states, and initial matrices for filtering and prediction.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare data and initialize matrices</span></span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(flu)</span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a>num <span class="ot">&lt;-</span> <span class="fu">length</span>(y)</span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a>nstate <span class="ot">&lt;-</span> <span class="dv">4</span></span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-6"><a href="#cb103-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Observation matrices</span></span>
<span id="cb103-7"><a href="#cb103-7" aria-hidden="true" tabindex="-1"></a>M1 <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">cbind</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>))  <span class="co"># Normal</span></span>
<span id="cb103-8"><a href="#cb103-8" aria-hidden="true" tabindex="-1"></a>M2 <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">cbind</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>))  <span class="co"># Epidemic</span></span>
<span id="cb103-9"><a href="#cb103-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-10"><a href="#cb103-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize storage for probabilities and filters</span></span>
<span id="cb103-11"><a href="#cb103-11" aria-hidden="true" tabindex="-1"></a>prob <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, num, <span class="dv">1</span>)</span>
<span id="cb103-12"><a href="#cb103-12" aria-hidden="true" tabindex="-1"></a>yp <span class="ot">&lt;-</span> y  <span class="co"># Store predictions</span></span>
<span id="cb103-13"><a href="#cb103-13" aria-hidden="true" tabindex="-1"></a>xfilter <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="at">dim =</span> <span class="fu">c</span>(nstate, <span class="dv">1</span>, num))  <span class="co"># Store filtered states</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="likelihood-function-2" class="level2" data-number="16.3">
<h2 data-number="16.3" class="anchored" data-anchor-id="likelihood-function-2"><span class="header-section-number">16.3</span> Likelihood Function</h2>
<p>The <code>Linn</code> function calculates the log-likelihood using the Kalman filter for a regime-switching model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define likelihood function</span></span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>Linn <span class="ot">&lt;-</span> <span class="cf">function</span>(para) {</span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>  alpha1 <span class="ot">&lt;-</span> para[<span class="dv">1</span>]</span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>  alpha2 <span class="ot">&lt;-</span> para[<span class="dv">2</span>]</span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>  beta0 <span class="ot">&lt;-</span> para[<span class="dv">3</span>]</span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a>  sQ1 <span class="ot">&lt;-</span> para[<span class="dv">4</span>]</span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true" tabindex="-1"></a>  sQ2 <span class="ot">&lt;-</span> para[<span class="dv">5</span>]</span>
<span id="cb104-8"><a href="#cb104-8" aria-hidden="true" tabindex="-1"></a>  like <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb104-9"><a href="#cb104-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-10"><a href="#cb104-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Initial filter and prediction</span></span>
<span id="cb104-11"><a href="#cb104-11" aria-hidden="true" tabindex="-1"></a>  xf <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, nstate, <span class="dv">1</span>)</span>
<span id="cb104-12"><a href="#cb104-12" aria-hidden="true" tabindex="-1"></a>  Pf <span class="ot">&lt;-</span> <span class="fu">diag</span>(<span class="fl">0.1</span>, nstate)  <span class="co"># Filter covariance</span></span>
<span id="cb104-13"><a href="#cb104-13" aria-hidden="true" tabindex="-1"></a>  Pp <span class="ot">&lt;-</span> <span class="fu">diag</span>(<span class="fl">0.1</span>, nstate)  <span class="co"># Prediction covariance</span></span>
<span id="cb104-14"><a href="#cb104-14" aria-hidden="true" tabindex="-1"></a>  phi <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, nstate, nstate)</span>
<span id="cb104-15"><a href="#cb104-15" aria-hidden="true" tabindex="-1"></a>  phi[<span class="dv">1</span>, <span class="dv">1</span>] <span class="ot">&lt;-</span> alpha1</span>
<span id="cb104-16"><a href="#cb104-16" aria-hidden="true" tabindex="-1"></a>  phi[<span class="dv">1</span>, <span class="dv">2</span>] <span class="ot">&lt;-</span> alpha2</span>
<span id="cb104-17"><a href="#cb104-17" aria-hidden="true" tabindex="-1"></a>  phi[<span class="dv">2</span>, <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb104-18"><a href="#cb104-18" aria-hidden="true" tabindex="-1"></a>  phi[<span class="dv">4</span>, <span class="dv">4</span>] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb104-19"><a href="#cb104-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-20"><a href="#cb104-20" aria-hidden="true" tabindex="-1"></a>  Ups <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">rbind</span>(<span class="dv">0</span>, <span class="dv">0</span>, beta0, <span class="dv">0</span>))</span>
<span id="cb104-21"><a href="#cb104-21" aria-hidden="true" tabindex="-1"></a>  Q <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, nstate, nstate)</span>
<span id="cb104-22"><a href="#cb104-22" aria-hidden="true" tabindex="-1"></a>  Q[<span class="dv">1</span>, <span class="dv">1</span>] <span class="ot">&lt;-</span> sQ1<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb104-23"><a href="#cb104-23" aria-hidden="true" tabindex="-1"></a>  Q[<span class="dv">3</span>, <span class="dv">3</span>] <span class="ot">&lt;-</span> sQ2<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb104-24"><a href="#cb104-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-25"><a href="#cb104-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Transition probabilities</span></span>
<span id="cb104-26"><a href="#cb104-26" aria-hidden="true" tabindex="-1"></a>  pi11 <span class="ot">&lt;-</span> <span class="fl">0.75</span></span>
<span id="cb104-27"><a href="#cb104-27" aria-hidden="true" tabindex="-1"></a>  pi12 <span class="ot">&lt;-</span> <span class="fl">0.25</span></span>
<span id="cb104-28"><a href="#cb104-28" aria-hidden="true" tabindex="-1"></a>  pi21 <span class="ot">&lt;-</span> <span class="fl">0.25</span></span>
<span id="cb104-29"><a href="#cb104-29" aria-hidden="true" tabindex="-1"></a>  pi22 <span class="ot">&lt;-</span> <span class="fl">0.75</span></span>
<span id="cb104-30"><a href="#cb104-30" aria-hidden="true" tabindex="-1"></a>  pif1 <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb104-31"><a href="#cb104-31" aria-hidden="true" tabindex="-1"></a>  pif2 <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb104-32"><a href="#cb104-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-33"><a href="#cb104-33" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Begin filtering</span></span>
<span id="cb104-34"><a href="#cb104-34" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>num) {</span>
<span id="cb104-35"><a href="#cb104-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Prediction step</span></span>
<span id="cb104-36"><a href="#cb104-36" aria-hidden="true" tabindex="-1"></a>    xp <span class="ot">&lt;-</span> phi <span class="sc">%*%</span> xf <span class="sc">+</span> Ups</span>
<span id="cb104-37"><a href="#cb104-37" aria-hidden="true" tabindex="-1"></a>    Pp <span class="ot">&lt;-</span> phi <span class="sc">%*%</span> Pf <span class="sc">%*%</span> <span class="fu">t</span>(phi) <span class="sc">+</span> Q</span>
<span id="cb104-38"><a href="#cb104-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-39"><a href="#cb104-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate likelihood for each regime</span></span>
<span id="cb104-40"><a href="#cb104-40" aria-hidden="true" tabindex="-1"></a>    sig1 <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(M1 <span class="sc">%*%</span> Pp <span class="sc">%*%</span> <span class="fu">t</span>(M1))</span>
<span id="cb104-41"><a href="#cb104-41" aria-hidden="true" tabindex="-1"></a>    sig2 <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(M2 <span class="sc">%*%</span> Pp <span class="sc">%*%</span> <span class="fu">t</span>(M2))</span>
<span id="cb104-42"><a href="#cb104-42" aria-hidden="true" tabindex="-1"></a>    k1 <span class="ot">&lt;-</span> Pp <span class="sc">%*%</span> <span class="fu">t</span>(M1) <span class="sc">/</span> sig1</span>
<span id="cb104-43"><a href="#cb104-43" aria-hidden="true" tabindex="-1"></a>    k2 <span class="ot">&lt;-</span> Pp <span class="sc">%*%</span> <span class="fu">t</span>(M2) <span class="sc">/</span> sig2</span>
<span id="cb104-44"><a href="#cb104-44" aria-hidden="true" tabindex="-1"></a>    e1 <span class="ot">&lt;-</span> y[i] <span class="sc">-</span> M1 <span class="sc">%*%</span> xp</span>
<span id="cb104-45"><a href="#cb104-45" aria-hidden="true" tabindex="-1"></a>    e2 <span class="ot">&lt;-</span> y[i] <span class="sc">-</span> M2 <span class="sc">%*%</span> xp</span>
<span id="cb104-46"><a href="#cb104-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-47"><a href="#cb104-47" aria-hidden="true" tabindex="-1"></a>    den1 <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">/</span> <span class="fu">sqrt</span>(sig1)) <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span><span class="fl">0.5</span> <span class="sc">*</span> e1<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> sig1)</span>
<span id="cb104-48"><a href="#cb104-48" aria-hidden="true" tabindex="-1"></a>    den2 <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">/</span> <span class="fu">sqrt</span>(sig2)) <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span><span class="fl">0.5</span> <span class="sc">*</span> e2<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> sig2)</span>
<span id="cb104-49"><a href="#cb104-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-50"><a href="#cb104-50" aria-hidden="true" tabindex="-1"></a>    pip1 <span class="ot">&lt;-</span> pif1 <span class="sc">*</span> pi11 <span class="sc">+</span> pif2 <span class="sc">*</span> pi21</span>
<span id="cb104-51"><a href="#cb104-51" aria-hidden="true" tabindex="-1"></a>    pip2 <span class="ot">&lt;-</span> pif1 <span class="sc">*</span> pi12 <span class="sc">+</span> pif2 <span class="sc">*</span> pi22</span>
<span id="cb104-52"><a href="#cb104-52" aria-hidden="true" tabindex="-1"></a>    pif1 <span class="ot">&lt;-</span> pip1 <span class="sc">*</span> den1 <span class="sc">/</span> (pip1 <span class="sc">*</span> den1 <span class="sc">+</span> pip2 <span class="sc">*</span> den2)</span>
<span id="cb104-53"><a href="#cb104-53" aria-hidden="true" tabindex="-1"></a>    pif2 <span class="ot">&lt;-</span> pip2 <span class="sc">*</span> den2 <span class="sc">/</span> (pip1 <span class="sc">*</span> den1 <span class="sc">+</span> pip2 <span class="sc">*</span> den2)</span>
<span id="cb104-54"><a href="#cb104-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-55"><a href="#cb104-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Update state</span></span>
<span id="cb104-56"><a href="#cb104-56" aria-hidden="true" tabindex="-1"></a>    pif1 <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(pif1)</span>
<span id="cb104-57"><a href="#cb104-57" aria-hidden="true" tabindex="-1"></a>    pif2 <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(pif2)</span>
<span id="cb104-58"><a href="#cb104-58" aria-hidden="true" tabindex="-1"></a>    e1 <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(e1)</span>
<span id="cb104-59"><a href="#cb104-59" aria-hidden="true" tabindex="-1"></a>    e2 <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(e2)</span>
<span id="cb104-60"><a href="#cb104-60" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb104-61"><a href="#cb104-61" aria-hidden="true" tabindex="-1"></a>    xf <span class="ot">&lt;-</span> xp <span class="sc">+</span> pif1 <span class="sc">*</span> k1 <span class="sc">*</span> e1 <span class="sc">+</span> pif2 <span class="sc">*</span> k2 <span class="sc">*</span> e2</span>
<span id="cb104-62"><a href="#cb104-62" aria-hidden="true" tabindex="-1"></a>    Pf <span class="ot">&lt;-</span> pif1 <span class="sc">*</span> (<span class="fu">diag</span>(<span class="dv">1</span>, nstate) <span class="sc">-</span> k1 <span class="sc">%*%</span> M1) <span class="sc">%*%</span> Pp <span class="sc">+</span></span>
<span id="cb104-63"><a href="#cb104-63" aria-hidden="true" tabindex="-1"></a>          pif2 <span class="sc">*</span> (<span class="fu">diag</span>(<span class="dv">1</span>, nstate) <span class="sc">-</span> k2 <span class="sc">%*%</span> M2) <span class="sc">%*%</span> Pp</span>
<span id="cb104-64"><a href="#cb104-64" aria-hidden="true" tabindex="-1"></a>    like <span class="ot">&lt;-</span> like <span class="sc">-</span> <span class="fu">log</span>(pip1 <span class="sc">*</span> den1 <span class="sc">+</span> pip2 <span class="sc">*</span> den2)</span>
<span id="cb104-65"><a href="#cb104-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-66"><a href="#cb104-66" aria-hidden="true" tabindex="-1"></a>    prob[i] <span class="ot">&lt;&lt;-</span> pip2</span>
<span id="cb104-67"><a href="#cb104-67" aria-hidden="true" tabindex="-1"></a>    xfilter[, , i] <span class="ot">&lt;&lt;-</span> xf</span>
<span id="cb104-68"><a href="#cb104-68" aria-hidden="true" tabindex="-1"></a>    yp[i] <span class="ot">&lt;&lt;-</span> <span class="fu">ifelse</span>(pip1 <span class="sc">&gt;</span> pip2, M1 <span class="sc">%*%</span> xp, M2 <span class="sc">%*%</span> xp)</span>
<span id="cb104-69"><a href="#cb104-69" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb104-70"><a href="#cb104-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(like)</span>
<span id="cb104-71"><a href="#cb104-71" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="parameter-estimation-4" class="level2" data-number="16.4">
<h2 data-number="16.4" class="anchored" data-anchor-id="parameter-estimation-4"><span class="header-section-number">16.4</span> Parameter Estimation</h2>
<p>We estimate the parameters using the <code>optim</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Initial parameters</span></span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>init.par <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">alpha1 =</span> <span class="fl">1.4</span>, <span class="at">alpha2 =</span> <span class="sc">-</span><span class="fl">0.5</span>, <span class="at">beta0 =</span> <span class="fl">0.3</span>, <span class="at">sQ1 =</span> <span class="fl">0.1</span>, <span class="at">sQ2 =</span> <span class="fl">0.1</span>)</span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform optimization</span></span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a>est <span class="ot">&lt;-</span> <span class="fu">optim</span>(init.par, Linn, <span class="cn">NULL</span>, <span class="at">method =</span> <span class="st">"BFGS"</span>, <span class="at">hessian =</span> <span class="cn">TRUE</span>, <span class="at">control =</span> <span class="fu">list</span>(<span class="at">trace =</span> <span class="dv">1</span>, <span class="at">REPORT =</span> <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>initial  value -236.860522 
iter   2 value -313.882451
iter   3 value -320.373891
iter   4 value -322.538581
iter   5 value -326.037522
iter   6 value -326.220434
iter   7 value -328.165001
iter   8 value -337.802054
iter   9 value -339.102455
iter  10 value -339.278478
iter  11 value -339.295742
iter  12 value -339.295935
iter  13 value -339.295949
iter  13 value -339.295949
final  value -339.295949 
converged</code></pre>
</div>
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>SE <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">diag</span>(<span class="fu">solve</span>(est<span class="sc">$</span>hessian)))</span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Display estimates and standard errors</span></span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a>u <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="at">estimate =</span> est<span class="sc">$</span>par, SE)</span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(u) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'alpha1'</span>, <span class="st">'alpha2'</span>, <span class="st">'beta0'</span>, <span class="st">'sQ1'</span>, <span class="st">'sQ2'</span>)</span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a>u</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          estimate          SE
alpha1  1.40570967 0.078587727
alpha2 -0.62198715 0.068733109
beta0   0.21049042 0.024625302
sQ1     0.02310306 0.001635291
sQ2     0.11217287 0.016684663</code></pre>
</div>
</div>
</section>
<section id="visualization-3" class="level2" data-number="16.5">
<h2 data-number="16.5" class="anchored" data-anchor-id="visualization-3"><span class="header-section-number">16.5</span> Visualization</h2>
<p>The plots below show the observed influenza counts, the filtered states, and the predicted counts with confidence intervals.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Graphics setup</span></span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>predepi <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(prob <span class="sc">&lt;</span> <span class="fl">0.5</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>k <span class="ot">&lt;-</span> <span class="dv">6</span><span class="sc">:</span><span class="fu">length</span>(y)</span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a>Time <span class="ot">&lt;-</span> <span class="fu">time</span>(flu)[k]</span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a>regime <span class="ot">&lt;-</span> predepi[k] <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb109-6"><a href="#cb109-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-7"><a href="#cb109-7" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">1</span>), <span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">1</span>, <span class="dv">1</span>) <span class="sc">+</span> <span class="fl">0.1</span>)</span>
<span id="cb109-8"><a href="#cb109-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-9"><a href="#cb109-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot (a): Observed data and regimes</span></span>
<span id="cb109-10"><a href="#cb109-10" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(Time, y[k], <span class="at">type =</span> <span class="st">"n"</span>, <span class="at">ylab =</span> <span class="st">""</span>)</span>
<span id="cb109-11"><a href="#cb109-11" aria-hidden="true" tabindex="-1"></a><span class="fu">grid</span>(<span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb109-12"><a href="#cb109-12" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(Time, y[k], <span class="at">col =</span> <span class="fu">gray</span>(<span class="fl">0.7</span>))</span>
<span id="cb109-13"><a href="#cb109-13" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(Time, y[k], <span class="at">col =</span> regime, <span class="at">labels =</span> regime, <span class="at">cex =</span> <span class="fl">1.1</span>)</span>
<span id="cb109-14"><a href="#cb109-14" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(<span class="dv">1979</span>, <span class="fl">0.95</span>, <span class="st">"(a)"</span>)</span>
<span id="cb109-15"><a href="#cb109-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-16"><a href="#cb109-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot (b): Filtered states</span></span>
<span id="cb109-17"><a href="#cb109-17" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(Time, xfilter[<span class="dv">1</span>, , k], <span class="at">type =</span> <span class="st">"n"</span>, <span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.1</span>, <span class="fl">0.4</span>), <span class="at">ylab =</span> <span class="st">""</span>)</span>
<span id="cb109-18"><a href="#cb109-18" aria-hidden="true" tabindex="-1"></a><span class="fu">grid</span>(<span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb109-19"><a href="#cb109-19" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(Time, xfilter[<span class="dv">1</span>, , k])</span>
<span id="cb109-20"><a href="#cb109-20" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(Time, xfilter[<span class="dv">3</span>, , k])</span>
<span id="cb109-21"><a href="#cb109-21" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(Time, xfilter[<span class="dv">4</span>, , k])</span>
<span id="cb109-22"><a href="#cb109-22" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(<span class="dv">1979</span>, <span class="fl">0.35</span>, <span class="st">"(b)"</span>)</span>
<span id="cb109-23"><a href="#cb109-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-24"><a href="#cb109-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot (c): Predictions with confidence intervals</span></span>
<span id="cb109-25"><a href="#cb109-25" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(Time, y[k], <span class="at">type =</span> <span class="st">"n"</span>, <span class="at">ylim =</span> <span class="fu">c</span>(<span class="fl">0.1</span>, <span class="fl">0.9</span>), <span class="at">ylab =</span> <span class="st">""</span>)</span>
<span id="cb109-26"><a href="#cb109-26" aria-hidden="true" tabindex="-1"></a><span class="fu">grid</span>(<span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb109-27"><a href="#cb109-27" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(Time, y[k], <span class="at">pch =</span> <span class="dv">19</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="cap6_files/figure-html/unnamed-chunk-51-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Bug in book's code </span></span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a><span class="co"># prde1 &lt;- 2 * sqrt(innov.sig[1])</span></span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a><span class="co"># prde2 &lt;- 2 * sqrt(innov.sig[2])</span></span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a><span class="co"># prde &lt;- ifelse(predepi[k] &lt; 0.5, prde1, prde2)</span></span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true" tabindex="-1"></a><span class="co"># xx &lt;- c(Time, rev(Time))</span></span>
<span id="cb110-7"><a href="#cb110-7" aria-hidden="true" tabindex="-1"></a><span class="co"># yy &lt;- c(yp[k] - prde, rev(yp[k] + prde))</span></span>
<span id="cb110-8"><a href="#cb110-8" aria-hidden="true" tabindex="-1"></a><span class="co"># polygon(xx, yy, border = 8, col = gray(0.6, alpha = 0.3))</span></span>
<span id="cb110-9"><a href="#cb110-9" aria-hidden="true" tabindex="-1"></a><span class="co"># text(1979, 0.85, "(c)")</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./cap5.html" class="pagination-link" aria-label="Capítulo 5">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Capítulo 5</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
  </div>
</nav>
</div> <!-- /content -->




</body></html>